<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Pinico Fighter</title>

<style>
body {
    margin: 0;
    background: #111;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    font-family: Arial;
    color: white;
}

.logo img {
    max-width: 220px;
    margin-bottom: 8px;
}

canvas {
    border: 3px solid #0f0;
}
</style>
</head>

<body>

<div class="logo">
    <img src="imagens/logo.png">
</div>

<canvas id="game" width="900" height="400"></canvas>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyDy_gqNrFR7KmMonXp7KfgRc15UVj0g3Nw",
  authDomain: "pinico-fighter.firebaseapp.com",
  databaseURL: "https://pinico-fighter-default-rtdb.firebaseio.com",
  projectId: "pinico-fighter",
  storageBucket: "pinico-fighter.firebasestorage.app",
  messagingSenderId: "152199667347",
  appId: "1:152199667347:web:9c74188c88bdee8633f766"
});

const db = firebase.database();

/* ================= PLAYER ================= */
const meuPlayer = prompt("Digite 1 para Player 1 ou 2 para Player 2");
const meuId = meuPlayer === "1" ? "p1" : "p2";
const inimigoId = meuId === "p1" ? "p2" : "p1";

/* ================= CANVAS ================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const fundo = new Image();
fundo.src = "imagens/fundo.png";

const GRAVIDADE = 0.8;
const CHAO = 320;
const LIM_ESQ = 40;
const LIM_DIR = canvas.width - 40;

/* ================= LUTADOR ================= */
class Lutador {
    constructor(x, cor, controles, direcao) {
        this.inicialX = x;
        this.x = x;
        this.y = CHAO;
        this.vy = 0;
        this.cor = cor;
        this.altura = 60;
        this.vel = 4;
        this.dir = direcao;
        this.pulando = false;
        this.atacando = false;
        this.tempoAtaque = 0;
        this.vida = 100;
        this.vivo = true;
        this.ctrl = controles;
    }

    mover(keys) {
        if (!this.vivo) return;
        if (keys[this.ctrl.esq]) { this.x -= this.vel; this.dir = -1; }
        if (keys[this.ctrl.dir]) { this.x += this.vel; this.dir = 1; }
        this.x = Math.max(LIM_ESQ, Math.min(LIM_DIR, this.x));
    }

    pular(keys) {
        if (keys[this.ctrl.pulo] && !this.pulando && this.vivo) {
            this.vy = -15;
            this.pulando = true;
        }
    }

    atacar(keys, inimigo) {
        if (!this.vivo) return;

        if (keys[this.ctrl.atk] && !this.atacando) {
            this.atacando = true;
            this.tempoAtaque = 10;

            const hit = {
                x: this.x + this.dir * 25,
                y: this.y - this.altura + 20,
                w: 25,
                h: 20
            };

            if (colisao(hit, inimigo.hitbox())) {
                inimigo.receberDano(10);
            }
        }

        if (this.atacando && --this.tempoAtaque <= 0) {
            this.atacando = false;
        }
    }

    receberDano(v) {
        this.vida -= v;
        if (this.vida <= 0) {
            this.vida = 0;
            this.vivo = false;
        }
    }

    fisica() {
        if (!this.vivo) { this.y = CHAO + 20; return; }
        this.y += this.vy;
        this.vy += GRAVIDADE;
        if (this.y >= CHAO) {
            this.y = CHAO;
            this.vy = 0;
            this.pulando = false;
        }
    }

    hitbox() {
        return { x: this.x - 10, y: this.y - this.altura - 10, w: 20, h: this.altura + 20 };
    }

    desenhar() {
        ctx.strokeStyle = this.cor;
        ctx.lineWidth = 4;

        if (!this.vivo) {
            ctx.beginPath();
            ctx.moveTo(this.x - 30, this.y);
            ctx.lineTo(this.x + 30, this.y);
            ctx.stroke();
            return;
        }

        const y = this.y - this.altura;
        ctx.beginPath(); ctx.moveTo(this.x, y); ctx.lineTo(this.x, this.y); ctx.stroke();
        ctx.beginPath(); ctx.arc(this.x, y - 10, 10, 0, Math.PI*2); ctx.stroke();

        const bx = this.x + this.dir * (this.atacando ? 30 : 15);
        ctx.beginPath(); ctx.moveTo(this.x, y+20); ctx.lineTo(bx, y+30); ctx.stroke();

        ctx.beginPath(); ctx.moveTo(this.x, y+20); ctx.lineTo(this.x - this.dir*10, y+30); ctx.stroke();
    }

    reset() {
        this.x = this.inicialX;
        this.y = CHAO;
        this.vy = 0;
        this.vida = 100;
        this.vivo = true;
    }
}

/* ================= UTILS ================= */
function colisao(a,b){
    return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y;
}

/* ================= INPUT ================= */
const keys = {};
addEventListener("keydown",e=>keys[e.key]=true);
addEventListener("keyup",e=>keys[e.key]=false);

/* ================= PLAYERS ================= */
const p1 = new Lutador(250,"cyan",{esq:"a",dir:"d",pulo:"w",atk:"f"},1);
const p2 = new Lutador(650,"red",{esq:"ArrowLeft",dir:"ArrowRight",pulo:"ArrowUp",atk:"Enter"},-1);

/* ================= FIREBASE SYNC ================= */
function enviar(j){
    db.ref("jogo/"+meuId).set({
        x:j.x,y:j.y,vida:j.vida,dir:j.dir,
        atacando:j.atacando,vivo:j.vivo
    });
}

db.ref("jogo/"+inimigoId).on("value",s=>{
    const d=s.val(); if(!d) return;
    const i=inimigoId==="p1"?p1:p2;
    Object.assign(i,d);
});

/* ================= UI ================= */
function barras(){
    ctx.fillStyle="red";
    ctx.fillRect(50,20,p1.vida*2,15);
    ctx.fillRect(900-50-p2.vida*2,20,p2.vida*2,15);
}

function fim(){
    ctx.fillStyle="white";
    ctx.font="26px Arial";
    ctx.textAlign="center";
    const vencedor=p1.vivo?"Player 1 venceu":"Player 2 venceu";
    ctx.fillText(vencedor,450,180);
    ctx.font="16px Arial";
    ctx.fillText("Pressione R para recome√ßar",450,210);
}

/* ================= LOOP ================= */
function loop(){
    ctx.clearRect(0,0,900,400);
    ctx.drawImage(fundo,0,CHAO-40,900,180);

    barras();

    if(meuId==="p1"){ p1.mover(keys); p1.pular(keys); p1.atacar(keys,p2); p1.fisica(); enviar(p1);}
    if(meuId==="p2"){ p2.mover(keys); p2.pular(keys); p2.atacar(keys,p1); p2.fisica(); enviar(p2);}

    p1.desenhar(); p2.desenhar();

    if(!p1.vivo||!p2.vivo){
        fim();
        if(keys["r"]||keys["R"]){ p1.reset(); p2.reset(); }
    }

    requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>
