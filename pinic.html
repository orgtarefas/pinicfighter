<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Pinico Fighter</title>

<style>
body {
    margin: 0;
    background: #111;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    font-family: Arial;
    color: white;
}

.logo img {
    max-width: 220px;
    margin-bottom: 8px;
}

canvas {
    border: 3px solid #0f0;
}
</style>
</head>

<body>

<div class="logo">
    <img src="imagens/logo.png">
</div>

<canvas id="game" width="900" height="400"></canvas>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  apiKey: "AIzaSyDy_gqNrFR7KmMonXp7KfgRc15UVj0g3Nw",
  authDomain: "pinico-fighter.firebaseapp.com",
  databaseURL: "https://pinico-fighter-default-rtdb.firebaseio.com",
  projectId: "pinico-fighter",
  storageBucket: "pinico-fighter.firebasestorage.app",
  messagingSenderId: "152199667347",
  appId: "1:152199667347:web:9c74188c88bdee8633f766"
});

const db = firebase.database();

/* ================= PLAYER ================= */
const meuPlayer = prompt("Digite 1 para Player 1 ou 2 para Player 2");
const meuId = meuPlayer === "1" ? "p1" : "p2";
const inimigoId = meuId === "p1" ? "p2" : "p1";

/* ================= CANVAS ================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const fundo = new Image();
fundo.src = "imagens/fundo.png";

const GRAVIDADE = 0.8;
const CHAO = 320;
const LIM_ESQ = 40;
const LIM_DIR = canvas.width - 40;

/* ================= LUTADOR COC√î COMPLETO ================= */
class LutadorCoco {
    constructor(x, cor, corSapato, controles, direcao, id) {
        this.id = id;
        this.inicialX = x;
        this.x = x;
        this.y = CHAO;
        this.vy = 0;
        this.cor = cor; // Cor do coc√¥
        this.corSapato = corSapato; // Cor do sapato
        this.altura = 60;
        this.vel = 4;
        this.dir = direcao;
        this.pulando = false;
        this.atacando = false;
        this.chutando = false;
        this.tempoAtaque = 0;
        this.tempoChute = 0;
        this.vida = 100;
        this.vivo = true;
        this.ctrl = controles;
        this.ultimoDano = 0;
        this.olhosAbertos = true;
        this.tempoPiscar = 0;
        this.pernaEsqFrente = true; // Altern√¢ncia das pernas ao andar
        this.anguloPerna = 0; // Para anima√ß√£o de andar
    }

    mover(keys) {
        if (!this.vivo) return;
        
        let andando = false;
        if (keys[this.ctrl.esq]) { 
            this.x -= this.vel; 
            this.dir = -1;
            andando = true;
        }
        if (keys[this.ctrl.dir]) { 
            this.x += this.vel; 
            this.dir = 1;
            andando = true;
        }
        
        // Anima pernas ao andar
        if (andando && !this.pulando && !this.chutando) {
            this.anguloPerna += 0.3;
            this.pernaEsqFrente = Math.sin(this.anguloPerna) > 0;
        } else if (!this.pulando && !this.chutando) {
            // Posi√ß√£o neutra das pernas
            this.pernaEsqFrente = true;
        }
        
        this.x = Math.max(LIM_ESQ, Math.min(LIM_DIR, this.x));
    }

    pular(keys) {
        if (keys[this.ctrl.pulo] && !this.pulando && this.vivo && !this.chutando) {
            this.vy = -15;
            this.pulando = true;
            this.pernaEsqFrente = false; // Pernas para tr√°s ao pular
        }
    }

    atacar(keys, inimigo) {
        if (!this.vivo || !inimigo.vivo) return;

        // ATAQUE DE SOCO
        if (keys[this.ctrl.atk] && !this.atacando && !this.chutando) {
            this.atacando = true;
            this.tempoAtaque = 8;
            this.olhosAbertos = false;

            const hit = {
                x: this.x + this.dir * 40,
                y: this.y - 30,
                w: 35,
                h: 25
            };

            if (colisao(hit, inimigo.hitbox())) {
                enviarDano(inimigo.id, 8);
                inimigo.receberDano(8);
            }
        }

        // ATAQUE DE CHUTE (tecla C para P1, tecla . (ponto) para P2)
        const teclaChute = this.id === "p1" ? "c" : ".";
        if (keys[teclaChute] && !this.chutando && !this.atacando) {
            this.chutando = true;
            this.tempoChute = 10;

            const hit = {
                x: this.x + this.dir * 45,
                y: this.y + 10, // Chute mais baixo
                w: 40,
                h: 20
            };

            if (colisao(hit, inimigo.hitbox())) {
                enviarDano(inimigo.id, 12); // Chute causa mais dano
                inimigo.receberDano(12);
            }
        }

        // Atualiza temporizadores
        if (this.atacando && --this.tempoAtaque <= 0) {
            this.atacando = false;
            this.olhosAbertos = true;
        }
        
        if (this.chutando && --this.tempoChute <= 0) {
            this.chutando = false;
        }
    }

    receberDano(v) {
        if (!this.vivo) return;
        
        const agora = Date.now();
        if (agora - this.ultimoDano < 500) return;
        this.ultimoDano = agora;
        
        this.vida -= v;
        if (this.vida <= 0) {
            this.vida = 0;
            this.vivo = false;
            this.y = CHAO + 10;
            this.vy = 0;
            
            enviarMorte(this.id);
        }
        
        enviarVida(this.id, this.vida);
        this.olhosAbertos = false;
        setTimeout(() => this.olhosAbertos = true, 200);
    }

    fisica() {
        if (!this.vivo) { 
            this.y = CHAO + 10; 
            this.vy = 0;
            return; 
        }
        this.y += this.vy;
        this.vy += GRAVIDADE;
        if (this.y >= CHAO) {
            this.y = CHAO;
            this.vy = 0;
            this.pulando = false;
        }
    }

    hitbox() {
        return { 
            x: this.x - 20, 
            y: this.y - 40, 
            w: 40, 
            h: 55 
        };
    }

    desenhar() {
        // Piscar os olhos aleatoriamente
        this.tempoPiscar++;
        if (this.tempoPiscar > 100) {
            this.olhosAbertos = !this.olhosAbertos;
            this.tempoPiscar = 0;
        }
        if (Math.random() < 0.005) {
            this.olhosAbertos = false;
            setTimeout(() => this.olhosAbertos = true, 100);
        }

        if (!this.vivo) {
            this.desenharMorto();
            return;
        }

        this.desenharVivo();
    }

    desenharVivo() {
        // CORPO DO COC√î
        ctx.fillStyle = this.cor;
        
        // Parte inferior do coc√¥
        ctx.beginPath();
        ctx.ellipse(this.x, this.y - 15, 25, 15, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // Parte m√©dia do coc√¥
        ctx.beginPath();
        ctx.ellipse(this.x, this.y - 25, 20, 12, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // Parte superior do coc√¥
        ctx.beginPath();
        ctx.ellipse(this.x, this.y - 35, 15, 10, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // Topo do coc√¥ (ponta)
        ctx.beginPath();
        ctx.ellipse(this.x, this.y - 43, 8, 6, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // DETALHES DO COC√î
        ctx.fillStyle = "#8B4513";
        for(let i = 0; i < 5; i++) {
            ctx.beginPath();
            ctx.ellipse(this.x - 15 + i * 7, this.y - 15, 2, 1.5, 0, 0, Math.PI * 2);
            ctx.fill();
        }
        
        for(let i = 0; i < 4; i++) {
            ctx.beginPath();
            ctx.ellipse(this.x - 10 + i * 6, this.y - 25, 2, 1.5, 0, 0, Math.PI * 2);
            ctx.fill();
        }
        
        for(let i = 0; i < 3; i++) {
            ctx.beginPath();
            ctx.ellipse(this.x - 7 + i * 5, this.y - 35, 2, 1.5, 0, 0, Math.PI * 2);
            ctx.fill();
        }

        // PERNAS
        this.desenharPernas();
        
        // BRA√áOS
        this.desenharBracos();
        
        // OLHOS
        this.desenharOlhos();
        
        // BOCA
        this.desenharBoca();
    }

    desenharPernas() {
        const alturaPerna = 30;
        const larguraPerna = 8;
        const yBase = this.y; // Base do corpo
        
        if (this.chutando) {
            // PERNAS DURANTE CHUTE
            ctx.fillStyle = this.cor;
            
            // Perna de apoio (n√£o-chutante)
            ctx.beginPath();
            ctx.roundRect(this.x - 8, yBase, larguraPerna, alturaPerna, 4);
            ctx.fill();
            
            // Perna chutante (esticada)
            const anguloChute = this.dir * 0.8; // √Çngulo do chute
            const comprimentoChute = 50;
            
            ctx.save();
            ctx.translate(this.x + this.dir * 10, yBase + 10);
            ctx.rotate(anguloChute);
            
            // Coxa
            ctx.fillStyle = this.cor;
            ctx.beginPath();
            ctx.roundRect(0, 0, larguraPerna, 25, 4);
            ctx.fill();
            
            // Canela
            ctx.beginPath();
            ctx.roundRect(0, 25, larguraPerna - 2, 25, 3);
            ctx.fill();
            
            // SAPATO do chute
            ctx.fillStyle = this.corSapato;
            ctx.beginPath();
            ctx.ellipse(0, 52, 15, 8, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Detalhe do sapato
            ctx.fillStyle = this.corSapato === "cyan" ? "#00aaff" : "#ff4444";
            ctx.beginPath();
            ctx.ellipse(5, 52, 8, 5, 0, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.restore();
            
        } else if (this.pulando) {
            // PERNAS AO PULAR
            ctx.fillStyle = this.cor;
            
            // Pernas flexionadas para tr√°s
            ctx.beginPath();
            ctx.roundRect(this.x - 12, yBase + 5, larguraPerna, alturaPerna - 10, 4);
            ctx.fill();
            
            ctx.beginPath();
            ctx.roundRect(this.x + 4, yBase + 5, larguraPerna, alturaPerna - 10, 4);
            ctx.fill();
            
            // Sapatos
            ctx.fillStyle = this.corSapato;
            ctx.beginPath();
            ctx.ellipse(this.x - 8, yBase + alturaPerna + 3, 12, 6, 0, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.beginPath();
            ctx.ellipse(this.x + 8, yBase + alturaPerna + 3, 12, 6, 0, 0, Math.PI * 2);
            ctx.fill();
            
        } else {
            // PERNAS NORMAIS (andando ou parado)
            ctx.fillStyle = this.cor;
            
            // Desenha pernas alternadas
            if (this.pernaEsqFrente) {
                // Perna esquerda na frente
                ctx.beginPath();
                ctx.roundRect(this.x - 12, yBase, larguraPerna, alturaPerna - 5, 4);
                ctx.fill();
                
                ctx.beginPath();
                ctx.roundRect(this.x + 4, yBase + 5, larguraPerna, alturaPerna - 10, 4);
                ctx.fill();
            } else {
                // Perna direita na frente
                ctx.beginPath();
                ctx.roundRect(this.x - 12, yBase + 5, larguraPerna, alturaPerna - 10, 4);
                ctx.fill();
                
                ctx.beginPath();
                ctx.roundRect(this.x + 4, yBase, larguraPerna, alturaPerna - 5, 4);
                ctx.fill();
            }
            
            // Sapatos
            ctx.fillStyle = this.corSapato;
            
            // Sapato esquerdo
            ctx.beginPath();
            ctx.ellipse(this.x - 8, yBase + alturaPerna, 12, 6, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Sapato direito
            ctx.beginPath();
            ctx.ellipse(this.x + 8, yBase + alturaPerna, 12, 6, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Detalhes dos sapatos (cadar√ßo/decora√ß√£o)
            ctx.fillStyle = this.corSapato === "cyan" ? "#00aaff" : "#ff4444";
            ctx.beginPath();
            ctx.ellipse(this.x - 8 + 4, yBase + alturaPerna, 8, 4, 0, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.beginPath();
            ctx.ellipse(this.x + 8 - 4, yBase + alturaPerna, 8, 4, 0, 0, Math.PI * 2);
            ctx.fill();
        }
    }

    desenharBracos() {
        ctx.strokeStyle = this.cor;
        ctx.lineWidth = 6;
        
        if (this.atacando) {
            // Bra√ßo atacante estendido
            const bracoX = this.x + this.dir * 35;
            const bracoY = this.y - 25;
            
            ctx.beginPath();
            ctx.moveTo(this.x + this.dir * 10, this.y - 25);
            ctx.lineTo(bracoX, bracoY);
            ctx.stroke();
            
            // "Punho" do coc√¥
            ctx.fillStyle = this.cor;
            ctx.beginPath();
            ctx.arc(bracoX, bracoY, 8, 0, Math.PI * 2);
            ctx.fill();
            
            // Outro bra√ßo (normal)
            ctx.beginPath();
            ctx.moveTo(this.x - this.dir * 10, this.y - 25);
            ctx.lineTo(this.x - this.dir * 25, this.y - 20);
            ctx.stroke();
        } else {
            // Bra√ßos normais
            const angulo = this.pulando ? 0.3 : 0;
            
            // Bra√ßo esquerdo
            ctx.beginPath();
            ctx.moveTo(this.x - 10, this.y - 25);
            ctx.lineTo(this.x - 25, this.y - 20 + (this.pulando ? -10 : 0));
            ctx.stroke();
            
            // Bra√ßo direito
            ctx.beginPath();
            ctx.moveTo(this.x + 10, this.y - 25);
            ctx.lineTo(this.x + 25, this.y - 20 + (this.pulando ? -10 : 0));
            ctx.stroke();
        }
    }

    desenharOlhos() {
        if (this.olhosAbertos) {
            ctx.fillStyle = "white";
            // Olho esquerdo
            ctx.beginPath();
            ctx.arc(this.x - 8, this.y - 40, 4, 0, Math.PI * 2);
            ctx.fill();
            // Olho direito
            ctx.beginPath();
            ctx.arc(this.x + 8, this.y - 40, 4, 0, Math.PI * 2);
            ctx.fill();
            
            // Pupilas
            ctx.fillStyle = "black";
            let pupilaX = 0;
            if (this.atacando || this.chutando) {
                pupilaX = this.dir * 2; // Olha na dire√ß√£o do ataque
            } else if (this.pulando) {
                pupilaX = 0; // Olha reto ao pular
            } else {
                pupilaX = this.dir * 1; // Olha na dire√ß√£o do movimento
            }
            
            ctx.beginPath();
            ctx.arc(this.x - 8 + pupilaX, this.y - 40, 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(this.x + 8 + pupilaX, this.y - 40, 2, 0, Math.PI * 2);
            ctx.fill();
        } else {
            // Olhos fechados
            ctx.strokeStyle = "black";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(this.x - 12, this.y - 40);
            ctx.lineTo(this.x - 4, this.y - 40);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(this.x + 4, this.y - 40);
            ctx.lineTo(this.x + 12, this.y - 40);
            ctx.stroke();
        }
    }

    desenharBoca() {
        ctx.strokeStyle = "black";
        ctx.lineWidth = 2;
        
        if (this.atacando) {
            // Boca gritando
            ctx.beginPath();
            ctx.arc(this.x, this.y - 35, 6, 0, Math.PI);
            ctx.stroke();
        } else if (this.chutando) {
            // Boca de esfor√ßo no chute
            ctx.beginPath();
            ctx.moveTo(this.x - 6, this.y - 32);
            ctx.lineTo(this.x + 6, this.y - 32);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(this.x - 4, this.y - 30);
            ctx.lineTo(this.x + 4, this.y - 30);
            ctx.stroke();
        } else if (this.pulando) {
            // Boca redonda de surpresa
            ctx.beginPath();
            ctx.arc(this.x, this.y - 32, 4, 0, Math.PI * 2);
            ctx.stroke();
        } else {
            // Boca normal (sorriso)
            ctx.beginPath();
            ctx.arc(this.x, this.y - 32, 5, 0.2, Math.PI - 0.2);
            ctx.stroke();
        }
    }

    desenharMorto() {
        ctx.fillStyle = this.cor;
        
        // Corpo do coc√¥ morto (achatado)
        ctx.beginPath();
        ctx.ellipse(this.x, this.y - 10, 30, 12, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // Detalhes
        ctx.fillStyle = "#8B4513";
        for(let i = 0; i < 3; i++) {
            ctx.beginPath();
            ctx.ellipse(this.x - 12 + i * 12, this.y - 10, 3, 2, 0, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // Pernas mortas (esticadas)
        ctx.fillStyle = this.cor;
        ctx.beginPath();
        ctx.roundRect(this.x - 15, this.y - 5, 8, 40, 3);
        ctx.fill();
        
        ctx.beginPath();
        ctx.roundRect(this.x + 7, this.y - 5, 8, 40, 3);
        ctx.fill();
        
        // Sapatos mortos
        ctx.fillStyle = this.corSapato;
        ctx.beginPath();
        ctx.ellipse(this.x - 11, this.y + 35, 10, 5, 0, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.beginPath();
        ctx.ellipse(this.x + 11, this.y + 35, 10, 5, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // Olhos em X (morto)
        ctx.strokeStyle = "black";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(this.x - 12, this.y - 25);
        ctx.lineTo(this.x - 4, this.y - 17);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(this.x - 4, this.y - 25);
        ctx.lineTo(this.x - 12, this.y - 17);
        ctx.stroke();
        
        ctx.beginPath();
        ctx.moveTo(this.x + 4, this.y - 25);
        ctx.lineTo(this.x + 12, this.y - 17);
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(this.x + 12, this.y - 25);
        ctx.lineTo(this.x + 4, this.y - 17);
        ctx.stroke();
    }

    reset() {
        this.x = this.inicialX;
        this.y = CHAO;
        this.vy = 0;
        this.vida = 100;
        this.vivo = true;
        this.atacando = false;
        this.chutando = false;
        this.tempoAtaque = 0;
        this.tempoChute = 0;
        this.ultimoDano = 0;
        this.olhosAbertos = true;
        this.tempoPiscar = 0;
        this.pernaEsqFrente = true;
        this.anguloPerna = 0;
    }
}

/* ================= UTILS ================= */
function colisao(a,b){
    return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y;
}

/* ================= INPUT ================= */
const keys = {};
addEventListener("keydown",e=>keys[e.key]=true);
addEventListener("keyup",e=>keys[e.key]=false);

/* ================= PLAYERS ================= */
// Controles: P1: A/D/W/F (soco)/C (chute), P2: Setas/Enter (soco)/. (ponto) (chute)
const p1 = new LutadorCoco(250,"#8B7355","cyan",{esq:"a",dir:"d",pulo:"w",atk:"f"},1,"p1");
const p2 = new LutadorCoco(650,"#8B7355","red",{esq:"ArrowLeft",dir:"ArrowRight",pulo:"ArrowUp",atk:"Enter"},-1,"p2");

/* ================= FIREBASE SYNC ================= */
let estouMorto = false;

function enviarPosicao(j){
    if (!j.vivo) return;
    
    db.ref("jogo/"+meuId).set({
        x: j.x, 
        y: j.y, 
        vida: j.vida, 
        dir: j.dir,
        atacando: j.atacando,
        chutando: j.chutando,
        vivo: j.vivo,
        pulando: j.pulando,
        olhosAbertos: j.olhosAbertos,
        pernaEsqFrente: j.pernaEsqFrente
    });
}

function enviarDano(idAlvo, dano) {
    db.ref("dano").set({
        alvo: idAlvo,
        valor: dano,
        tempo: Date.now()
    });
}

function enviarVida(id, vida) {
    db.ref("vida/"+id).set(vida);
}

function enviarMorte(id) {
    db.ref("morte").set({
        id: id,
        tempo: Date.now()
    });
}

// Escuta por danos
db.ref("dano").on("value", s => {
    const d = s.val();
    if (!d || d.alvo !== meuId) return;
    
    const jogador = meuId === "p1" ? p1 : p2;
    jogador.receberDano(d.valor);
});

// Escuta por atualiza√ß√µes de vida
db.ref("vida/"+meuId).on("value", s => {
    const vida = s.val();
    if (vida !== null && vida !== undefined) {
        const jogador = meuId === "p1" ? p1 : p2;
        if (vida < jogador.vida) {
            jogador.vida = vida;
            if (jogador.vida <= 0) {
                jogador.vida = 0;
                jogador.vivo = false;
                estouMorto = true;
            }
        }
    }
});

// Escuta por mortes
db.ref("morte").on("value", s => {
    const m = s.val();
    if (!m) return;
    
    const jogador = m.id === "p1" ? p1 : p2;
    jogador.vida = 0;
    jogador.vivo = false;
    jogador.y = CHAO + 10;
});

// Escuta por posi√ß√£o do inimigo
db.ref("jogo/"+inimigoId).on("value", s => {
    const d = s.val();
    if (!d) return;
    
    const inimigo = inimigoId === "p1" ? p1 : p2;
    
    if (inimigo.vivo || d.vivo === false) {
        inimigo.x = d.x || inimigo.x;
        inimigo.y = d.y || inimigo.y;
        inimigo.dir = d.dir || inimigo.dir;
        inimigo.atacando = d.atacando || false;
        inimigo.chutando = d.chutando || false;
        inimigo.pulando = d.pulando || false;
        inimigo.olhosAbertos = d.olhosAbertos !== undefined ? d.olhosAbertos : inimigo.olhosAbertos;
        inimigo.pernaEsqFrente = d.pernaEsqFrente !== undefined ? d.pernaEsqFrente : inimigo.pernaEsqFrente;
        
        if (d.vida !== undefined && d.vida < inimigo.vida) {
            inimigo.vida = d.vida;
        }
        
        if (d.vivo === false) {
            inimigo.vivo = false;
            inimigo.vida = 0;
        }
    }
});

/* ================= UI ================= */
function barras(){
    // Barra de vida P1
    ctx.fillStyle = "#333";
    ctx.fillRect(50, 20, 200, 20);
    ctx.fillStyle = "cyan";
    ctx.fillRect(50, 20, p1.vida*2, 20);
    
    // Barra de vida P2
    ctx.fillStyle = "#333";
    ctx.fillRect(650, 20, 200, 20);
    ctx.fillStyle = "red";
    ctx.fillRect(650, 20, p2.vida*2, 20);
    
    // Texto de vida
    ctx.fillStyle = "white";
    ctx.font = "14px Arial";
    ctx.fillText(`P1: ${p1.vida}`, 50, 45);
    ctx.fillText(`P2: ${p2.vida}`, 650, 45);
    
    // Controles
    ctx.font = "12px Arial";
    ctx.fillText("Soco: F | Chute: C", 50, 65);
    ctx.fillText("Soco: Enter | Chute: .", 650, 65);
    
    // Bordas
    ctx.strokeStyle = "white";
    ctx.lineWidth = 2;
    ctx.strokeRect(50, 20, 200, 20);
    ctx.strokeRect(650, 20, 200, 20);
}

function fim(){
    ctx.fillStyle = "white";
    ctx.font = "26px Arial";
    ctx.textAlign = "center";
    const vencedor = p1.vivo ? "Player 1 venceu! üí©üëä" : "Player 2 venceu! üí©üëä";
    ctx.fillText(vencedor, 450, 180);
    ctx.font = "16px Arial";
    ctx.fillText("Pressione R para recome√ßar", 450, 210);
}

/* ================= LOOP ================= */
function loop(){
    ctx.clearRect(0,0,900,400);
    ctx.drawImage(fundo,0,CHAO-40,900,180);

    barras();

    const jogadorLocal = meuId === "p1" ? p1 : p2;
    const inimigoLocal = meuId === "p1" ? p2 : p1;
    
    if (jogadorLocal.vivo) {
        jogadorLocal.mover(keys);
        jogadorLocal.pular(keys);
        jogadorLocal.atacar(keys, inimigoLocal);
        jogadorLocal.fisica();
    }
    
    inimigoLocal.fisica();

    if (jogadorLocal.vivo) {
        enviarPosicao(jogadorLocal);
    }

    p1.desenhar();
    p2.desenhar();

    if(!p1.vivo || !p2.vivo){
        fim();
        if(keys["r"] || keys["R"]){
            p1.reset();
            p2.reset();
            estouMorto = false;
            
            db.ref("reinicio").set({
                tempo: Date.now(),
                jogador: meuId
            });
        }
    }

    requestAnimationFrame(loop);
}

// Escuta por rein√≠cio
db.ref("reinicio").on("value", s => {
    const r = s.val();
    if (!r) return;
    
    p1.reset();
    p2.reset();
    estouMorto = false;
});

// Inicializa dados no Firebase
db.ref("jogo").set({
    p1: {x: 250, y: CHAO, vida: 100, dir: 1, atacando: false, chutando: false, vivo: true, pulando: false, olhosAbertos: true, pernaEsqFrente: true},
    p2: {x: 650, y: CHAO, vida: 100, dir: -1, atacando: false, chutando: false, vivo: true, pulando: false, olhosAbertos: true, pernaEsqFrente: true}
});

db.ref("vida").set({
    p1: 100,
    p2: 100
});

fundo.onload = loop;
</script>
</body>
</html>
