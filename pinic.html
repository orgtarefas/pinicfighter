<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Pinic Fighter</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* Estilos gerais para todas as telas */
        .tela-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #111, #333);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .logo-selecao {
            max-width: 300px;
            margin-bottom: 30px;
        }
        
        .titulo-tela {
            font-size: 36px;
            color: #0f0;
            text-shadow: 0 0 10px #0f0;
            margin-bottom: 30px;
            font-family: 'Arial Black', sans-serif;
            text-transform: uppercase;
        }
        
        .subtitulo-tela {
            font-size: 18px;
            color: white;
            margin-bottom: 40px;
            text-align: center;
            max-width: 600px;
        }
        
        /* Tela inicial (menu) */
        .menu-opcoes {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 300px;
        }
        
        .btn-menu {
            background: #0f0;
            color: black;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            text-align: center;
        }
        
        .btn-menu:hover {
            background: #0c0;
            transform: scale(1.05);
            box-shadow: 0 0 20px #0f0;
        }
        
        /* Tela de criar sala */
        .form-sala {
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 400px;
            align-items: center;
        }
        
        .input-sala {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #0f0;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 10px;
            text-align: center;
        }
        
        .input-sala::placeholder {
            color: #888;
        }
        
        .btn-voltar {
            background: transparent;
            color: #0f0;
            border: 2px solid #0f0;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }
        
        .btn-voltar:hover {
            background: rgba(0, 255, 0, 0.1);
        }
        
        /* Tela de listar salas */
        .lista-salas {
            width: 600px;
            max-height: 400px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .sala-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .sala-item:hover {
            background: rgba(0, 255, 0, 0.2);
            transform: translateX(5px);
        }
        
        .sala-nome {
            font-size: 20px;
            color: white;
            font-weight: bold;
        }
        
        .sala-info {
            color: #0f0;
            font-size: 14px;
        }
        
        /* Tela de sele√ß√£o de player */
        .selecao-players {
            display: flex;
            gap: 50px;
            margin-bottom: 40px;
        }
        
        .player-opcao {
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s;
            padding: 30px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            width: 200px;
        }
        
        .player-opcao:hover {
            transform: scale(1.1);
            background: rgba(0, 255, 0, 0.2);
        }
        
        .player-opcao.selecionado {
            background: rgba(0, 255, 0, 0.3);
            box-shadow: 0 0 30px #0f0;
        }
        
        .player-numero {
            font-size: 28px;
            color: #0f0;
            margin-bottom: 15px;
        }
        
        .player-avatar {
            font-size: 60px;
            margin-bottom: 15px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .player-controles {
            color: #ccc;
            font-size: 14px;
            margin-top: 10px;
        }
        
        /* Tela de sele√ß√£o de personagem */
        .personagens-lista {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        .personagem-opcao {
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            padding: 20px;
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.1);
            width: 280px; /* Aumentado para caber especiais */
            min-height: 380px; /* Aumentado para caber especiais */
        }
        
        .personagem-opcao:hover {
            transform: translateY(-10px);
            background: rgba(0, 255, 0, 0.2);
        }
        
        .personagem-opcao.selecionado {
            background: rgba(0, 255, 0, 0.3);
            box-shadow: 0 0 30px #0f0;
        }
        
        .personagem-icone {
            font-size: 70px;
            margin-bottom: 15px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .personagem-nome {
            font-size: 22px;
            color: white;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .personagem-desc {
            color: #ccc;
            font-size: 14px;
            margin-bottom: 15px;
            min-height: 60px;
        }
        
        .personagem-habilidade {
            color: #ff0;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        /* Se√ß√£o de especiais dos personagens */
        .personagem-especiais {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            text-align: left;
        }
        
        .especial-item {
            margin-bottom: 10px;
            padding: 5px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
        }
        
        .especial-nome {
            display: block;
            color: #0ff;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 3px;
        }
        
        .especial-comando {
            display: block;
            color: #ff0;
            font-size: 11px;
            font-family: 'Courier New', monospace;
        }
        
        /* Bot√µes */
        .btn-confirmar {
            background: #0f0;
            color: black;
            border: none;
            padding: 15px 40px;
            font-size: 20px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }
        
        .btn-confirmar:hover {
            background: #0c0;
            transform: scale(1.1);
            box-shadow: 0 0 20px #0f0;
        }
        
        .btn-confirmar:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Info da sala durante o jogo */
        .info-sala {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #0f0;
            font-size: 16px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 10px;
            z-index: 100;
        }
        
        /* Jogadores na sala */
        .jogadores-sala {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 16px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 10px;
            z-index: 100;
            max-width: 300px;
        }
        
        .jogador-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 5px;
        }
        
        .jogador-item.eu {
            background: rgba(0, 255, 0, 0.2);
        }
        
        /* Jogo principal */
        #jogoPrincipal {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        
        /* Mensagens */
        .mensagem {
            color: #ff0;
            font-size: 18px;
            margin-top: 20px;
            text-align: center;
            min-height: 30px;
        }
        
        /* Loading */
        .loading {
            color: #0f0;
            font-size: 20px;
            margin-top: 20px;
            display: none;
        }
        
        .loading span {
            animation: piscar 1.5s infinite;
        }
        
        @keyframes piscar {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <!-- Tela 1: Menu Principal -->
    <div id="telaMenu" class="tela-container">
        <img src="imagens/logo.png" alt="Pinic Fighter" class="logo-selecao">
        <div class="titulo-tela">S√ì OS MAIS FORTES SOBREVIVEM!</div>
        <div class="subtitulo-tela">Lute com amigos em salas multiplayer!</div>
        
        <div class="menu-opcoes">
            <button id="btnCriarSala" class="btn-menu">CRIAR NOVA SALA</button>
            <button id="btnEntrarSala" class="btn-menu">ENTRAR EM UMA SALA</button>
        </div>
    </div>
    
    <!-- Tela 2: Criar Sala -->
    <div id="telaCriarSala" class="tela-container" style="display: none;">
        <img src="imagens/logo.png" alt="Pinic Fighter" class="logo-selecao">
        <div class="titulo-tela">CRIAR SALA</div>
        <div class="subtitulo-tela">Digite um nome √∫nico para sua sala</div>
        
        <div class="form-sala">
            <input type="text" id="nomeSala" class="input-sala" placeholder="Ex: Sala do Jo√£o, Fight Club, etc." maxlength="30">
            <button id="btnCriar" class="btn-confirmar">CRIAR SALA</button>
            <div id="mensagemCriar" class="mensagem"></div>
            <button id="btnVoltarCriar" class="btn-voltar">‚Üê VOLTAR</button>
        </div>
    </div>
    
    <!-- Tela 3: Listar Salas -->
    <div id="telaListarSalas" class="tela-container" style="display: none;">
        <img src="imagens/logo.png" alt="Pinic Fighter" class="logo-selecao">
        <div class="titulo-tela">SALAS DISPON√çVEIS</div>
        <div class="subtitulo-tela">Clique em uma sala para entrar</div>
        
        <div id="listaSalas" class="lista-salas">
            <!-- Salas ser√£o carregadas aqui -->
        </div>
        
        <div id="mensagemSalas" class="mensagem"></div>
        <div id="loadingSalas" class="loading" style="display: none;">Carregando salas<span>...</span></div>
        
        <button id="btnAtualizarSalas" class="btn-confirmar">ATUALIZAR</button>
        <button id="btnVoltarSalas" class="btn-voltar">‚Üê VOLTAR AO MENU</button>
    </div>
    
    <!-- Tela 4: Sele√ß√£o de Player -->
    <div id="telaSelecaoPlayer" class="tela-container" style="display: none;">
        <img src="imagens/logo.png" alt="Pinic Fighter" class="logo-selecao">
        <div class="titulo-tela">ESCOLHA SEU PLAYER</div>
        <div class="subtitulo-tela" id="subtituloSala">Sala: <span id="nomeSalaAtual"></span></div>
        
        <div class="selecao-players">
            <div class="player-opcao" data-player="1">
                <div class="player-numero">PLAYER 1</div>
                <div class="player-avatar">üë§</div>
                <div class="player-controles">
                    MOVER: A/D<br>
                    PULAR: W<br>
                    SOCAR: F<br>
                    CHUTAR: C
                </div>
            </div>
            
            <div class="player-opcao" data-player="2">
                <div class="player-numero">PLAYER 2</div>
                <div class="player-avatar">üë§</div>
                <div class="player-controles">
                    MOVER: ‚Üê/‚Üí<br>
                    PULAR: ‚Üë<br>
                    SOCAR: Enter<br>
                    CHUTAR: .
                </div>
            </div>
            
            <div class="player-opcao" data-player="3">
                <div class="player-numero">PLAYER 3</div>
                <div class="player-avatar">üë§</div>
                <div class="player-controles">
                    MOVER: J/L<br>
                    PULAR: I<br>
                    SOCAR: H<br>
                    CHUTAR: N
                </div>
            </div>
            
            <div class="player-opcao" data-player="4">
                <div class="player-numero">PLAYER 4</div>
                <div class="player-avatar">üë§</div>
                <div class="player-controles">
                    MOVER: NUM4/NUM6<br>
                    PULAR: NUM8<br>
                    SOCAR: NUM0<br>
                    CHUTAR: NUM.
                </div>
            </div>
        </div>
        
        <div id="mensagemPlayer" class="mensagem"></div>
        <button id="btnContinuarPersonagem" class="btn-confirmar">CONTINUAR</button>
        <button id="btnVoltarPlayer" class="btn-voltar">‚Üê VOLTAR</button>
    </div>
    
    <!-- Tela 5: Sele√ß√£o de Personagem -->
    <div id="telaSelecaoPersonagem" class="tela-container" style="display: none;">
        <img src="imagens/logo.png" alt="Pinic Fighter" class="logo-selecao">
        <div class="titulo-tela">ESCOLHA SEU PERSONAGEM</div>
        <div class="subtitulo-tela" id="subtituloSalaPersonagem">Sala: <span id="nomeSalaAtualPersonagem"></span> | Player: <span id="playerSelecionado"></span></div>
        
        <div class="personagens-lista">
            <!-- Cocozin -->
            <div class="personagem-opcao" data-personagem="cocozin">
                <div class="personagem-icone">üí©</div>
                <div class="personagem-nome">Cocozin</div>
                <div class="personagem-desc">
                    O cl√°ssico lutador de coc√¥!<br>
                    Equilibrado em ataque e defesa.
                </div>
                <div class="personagem-habilidade">ATAQUES ESPECIAIS:</div>
                
                <div class="personagem-especiais">
                    <div class="especial-item">
                        <span class="especial-nome">Bomba de Coc√¥:</span>
                        <span class="especial-comando">[PULAR] + [ABAIXAR] (no ar)</span>
                    </div>
                </div>
            </div>
            
            <!-- Ratazana -->
            <div class="personagem-opcao" data-personagem="ratazana">
                <div class="personagem-icone">üêÄ</div>
                <div class="personagem-nome">Ratazana</div>
                <div class="personagem-desc">
                    Rato boxeador veloz!<br>
                    Socos r√°pidos e poderosos.
                </div>
                <div class="personagem-habilidade">ATAQUES ESPECIAIS:</div>
                
                <div class="personagem-especiais">
                    <div class="especial-item">
                        <span class="especial-nome">Mordida R√°pida:</span>
                        <span class="especial-comando">[ABAIXAR] + [SOCAR]</span>
                    </div>
                    <div class="especial-item">
                        <span class="especial-nome">Cauda Girat√≥ria:</span>
                        <span class="especial-comando">[ABAIXAR] + [CHUTAR]</span>
                    </div>
                </div>
            </div>
            
            <!-- Peidov√©lio -->
            <div class="personagem-opcao" data-personagem="peidov√©lio">
                <div class="personagem-icone">üí®</div>
                <div class="personagem-nome">Peidov√©lio</div>
                <div class="personagem-desc">
                    Ser de fuma√ßa t√≥xico!<br>
                    Ataques com efeito venenoso.
                </div>
                <div class="personagem-habilidade">ATAQUES ESPECIAIS:</div>
                
                <div class="personagem-especiais">
                    <div class="especial-item">
                        <span class="especial-nome">Nuvem T√≥xica:</span>
                        <span class="especial-comando">[ABAIXAR] + [SOCAR]</span>
                    </div>
                    <div class="especial-item">
                        <span class="especial-nome">Tornado de Peido:</span>
                        <span class="especial-comando">[PULAR] + [ABAIXAR] + [CHUTAR] (no ch√£o)</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="mensagemPersonagem" class="mensagem"></div>
        <button id="btnConfirmarPersonagem" class="btn-confirmar">ENTRAR NA SALA</button>
        <button id="btnVoltarPersonagem" class="btn-voltar">‚Üê VOLTAR</button>
        <div id="loadingEntrada" class="loading" style="display: none;">Entrando na sala<span>...</span></div>
    </div>
    
    <!-- Tela 6: Jogo Principal -->
    <div id="jogoPrincipal" class="tela-container">
        <div class="info-sala" id="infoSalaJogo"></div>
        <div class="jogadores-sala" id="jogadoresSala">
            <!-- Bot√£o para dono da sala -->
            <button id="btnExcluirSala" class="btn-excluir" style="display: none;">
                üóëÔ∏è EXCLUIR SALA
            </button>
        </div>
        
        <div class="logo">
            <img src="imagens/logo.png" alt="Pinic Fighter">
        </div>
        <canvas id="game" width="900" height="400"></canvas>
        
        <div class="controles-jogo">
            <button id="btnSairSala" class="btn-voltar">SAIR DA SALA</button>
            <button id="btnExcluirSalaFooter" class="btn-excluir" style="display: none; margin-left: 20px;">
                üóëÔ∏è EXCLUIR SALA
            </button>
        </div>
    </div>

    <!-- Firebase primeiro -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <!-- Configura√ß√µes -->
    <script src="js/firebase-config.js"></script>
    <script src="js/utils.js"></script>
    
    <!-- Jogo (NOVA ORDEM) -->
    <script src="js/fighter.js"></script>  <!-- Primeiro (mais b√°sico) -->
    <script src="js/coco-projetil.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/game.js"></script>  <!-- √öltimo (usa tudo) -->
    <script src="js/cleanup.js"></script>

    <!-- ============================================ -->
    <!-- PONTE ENTRE SISTEMA DE SALAS E JOGO -->
    <!-- ============================================ -->
    <script>
    // Esta fun√ß√£o conecta o sistema de salas com o game.js
    window.inicializarJogoSala = function(nomeSala, playerNum, personagem) {
        console.log(`üéÆ [PONTE] Conectando sala ao jogo: ${nomeSala} - P${playerNum} - ${personagem}`);
        
        // Guardar nas vari√°veis globais (para outros scripts usarem)
        window.salaAtual = nomeSala;
        window.playerSelecionado = playerNum;
        window.personagemSelecionado = personagem;
        
        // Chamar a fun√ß√£o que realmente existe no game.js
        if (typeof window.inicializarJogoMultiplayer === 'function') {
            setTimeout(() => {
                window.inicializarJogoMultiplayer(nomeSala, playerNum, personagem);
            }, 100);
        } else {
            console.error('‚ùå ERRO: Fun√ß√£o inicializarJogoMultiplayer n√£o encontrada!');
            console.log('üîç Verificando carregamento dos arquivos...');
            
            // Tentar fallback b√°sico
            iniciarJogoBasico(nomeSala, playerNum, personagem);
        }
    };
    
    // Fallback b√°sico caso o game.js n√£o carregue
    function iniciarJogoBasico(sala, player, personagem) {
        console.log('üîÑ Iniciando modo b√°sico de demonstra√ß√£o');
        
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        
        // Criar personagem b√°sico
        const jogadorBasico = {
            x: 150 + ((parseInt(player) - 1) * 200),
            y: 300,
            largura: 50,
            altura: 80,
            cor: personagem === 'cocozin' ? '#8B7355' : 
                 personagem === 'ratazana' ? '#696969' : '#808080',
            desenhar: function() {
                ctx.fillStyle = this.cor;
                ctx.fillRect(this.x, this.y, this.largura, this.altura);
                
                // Desenhar nome
                ctx.fillStyle = 'white';
                ctx.font = '14px Arial';
                ctx.fillText(`P${player}: ${personagem}`, this.x, this.y - 10);
            }
        };
        
        function loopBasico() {
            ctx.clearRect(0, 0, 900, 400);
            
            // Desenhar fundo
            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, 900, 400);
            
            // Desenhar ch√£o
            ctx.fillStyle = '#333';
            ctx.fillRect(0, 340, 900, 60);
            
            // Desenhar personagem
            jogadorBasico.desenhar();
            
            // Texto informativo
            ctx.fillStyle = '#0f0';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('üéÆ MODO DEMONSTRA√á√ÉO', 450, 50);
            ctx.fillText(`Sala: ${sala} | Player: ${player} | Personagem: ${personagem}`, 450, 80);
            ctx.fillStyle = '#ff0';
            ctx.fillText('Game.js n√£o carregou corretamente', 450, 350);
            ctx.fillText('Verifique o console para erros', 450, 370);
            
            requestAnimationFrame(loopBasico);
        }
        
        loopBasico();
    }
    </script>
    

    <!-- Sistema de Salas -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Refer√™ncias √†s telas
        const telas = {
            menu: document.getElementById('telaMenu'),
            criarSala: document.getElementById('telaCriarSala'),
            listarSalas: document.getElementById('telaListarSalas'),
            selecaoPlayer: document.getElementById('telaSelecaoPlayer'),
            selecaoPersonagem: document.getElementById('telaSelecaoPersonagem'),
            jogo: document.getElementById('jogoPrincipal')
        };

        let heartbeatInterval = null; 
        
        // Elementos de input/mensagem
        const nomeSalaInput = document.getElementById('nomeSala');
        const mensagemCriar = document.getElementById('mensagemCriar');
        const listaSalasDiv = document.getElementById('listaSalas');
        const mensagemSalas = document.getElementById('mensagemSalas');
        const loadingSalas = document.getElementById('loadingSalas');
        const nomeSalaAtual = document.getElementById('nomeSalaAtual');
        const nomeSalaAtualPersonagem = document.getElementById('nomeSalaAtualPersonagem');
        const playerSelecionadoSpan = document.getElementById('playerSelecionado');
        const subtituloSala = document.getElementById('subtituloSala');
        const subtituloSalaPersonagem = document.getElementById('subtituloSalaPersonagem');
        const mensagemPlayer = document.getElementById('mensagemPlayer');
        const mensagemPersonagem = document.getElementById('mensagemPersonagem');
        const loadingEntrada = document.getElementById('loadingEntrada');
        const infoSalaJogo = document.getElementById('infoSalaJogo');
        const jogadoresSala = document.getElementById('jogadoresSala');
        
        // Vari√°veis de estado
        let nomeSalaSelecionada = '';
        let playerSelecionado = null;
        let personagemSelecionado = null;
        let salaAtual = '';
        let jogadoresNaSala = {};

        // === Fun√ß√£o do heartbeat ===
        function iniciarHeartbeat() {
            console.log('üíì Iniciando sistema de heartbeat...');
            
            // Parar qualquer heartbeat anterior
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
            }
            
            // Verificar se temos os dados necess√°rios
            if (!salaAtual || !playerSelecionado) {
                console.log('‚ùå Heartbeat n√£o iniciado: falta dados da sala');
                return;
            }
            
            console.log(`üíì Heartbeat ativo para: ${salaAtual} - Player ${playerSelecionado}`);
            
            // Criar intervalo que roda a cada 30 segundos
            heartbeatInterval = setInterval(() => {
                const timestamp = Date.now();
                console.log(`üíì [${new Date(timestamp).toLocaleTimeString()}] Enviando sinal...`);
                
                // Enviar para Firebase (se dispon√≠vel)
                if (typeof window.atualizarHeartbeat === 'function') {
                    window.atualizarHeartbeat(salaAtual, playerSelecionado, timestamp);
                }
                
                // Atualizar localStorage tamb√©m
                try {
                    const sessao = JSON.parse(localStorage.getItem('pinic_ultima_sessao') || '{}');
                    if (sessao.sala === salaAtual && sessao.player === playerSelecionado) {
                        sessao.lastHeartbeat = timestamp;
                        localStorage.setItem('pinic_ultima_sessao', JSON.stringify(sessao));
                    }
                } catch (e) {
                    // Ignorar erro
                }
                
            }, 30000); // 30 segundos
            
            // Enviar primeiro heartbeat imediatamente
            setTimeout(() => {
                const timestamp = Date.now();
                if (typeof window.atualizarHeartbeat === 'function') {
                    window.atualizarHeartbeat(salaAtual, playerSelecionado, timestamp);
                }
                console.log('üíì Primeiro heartbeat enviado');
            }, 500);
        }
        
        // Navega√ß√£o entre telas
        function mostrarTela(tela) {
            Object.values(telas).forEach(t => t.style.display = 'none');
            tela.style.display = 'flex';
        }
        
        // 1. MENU PRINCIPAL
        document.getElementById('btnCriarSala').addEventListener('click', () => {
            mostrarTela(telas.criarSala);
            nomeSalaInput.value = '';
            mensagemCriar.textContent = '';
        });
        
        document.getElementById('btnEntrarSala').addEventListener('click', () => {
            mostrarTela(telas.listarSalas);
            carregarSalas();
        });
        
        // 2. CRIAR SALA
        document.getElementById('btnVoltarCriar').addEventListener('click', () => {
            mostrarTela(telas.menu);
        });
        
        document.getElementById('btnCriar').addEventListener('click', criarSala);
        nomeSalaInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') criarSala();
        });
        
        function criarSala() {
            const nomeSala = nomeSalaInput.value.trim();
            
            if (!nomeSala) {
                mensagemCriar.textContent = 'Digite um nome para a sala!';
                mensagemCriar.style.color = '#ff0';
                return;
            }
            
            if (nomeSala.length < 3) {
                mensagemCriar.textContent = 'Nome muito curto (m√≠nimo 3 caracteres)!';
                mensagemCriar.style.color = '#ff0';
                return;
            }
            
            if (nomeSala.length > 30) {
                mensagemCriar.textContent = 'Nome muito longo (m√°ximo 30 caracteres)!';
                mensagemCriar.style.color = '#ff0';
                return;
            }
            
            // Verifica se sala j√° existe via Firebase
            if (typeof window.verificarECriarSala === 'function') {
                window.verificarECriarSala(nomeSala, (sucesso, mensagem) => {
                    if (sucesso) {
                        nomeSalaSelecionada = nomeSala;
                        mostrarTelaSelecaoPlayer();
                    } else {
                        mensagemCriar.textContent = mensagem;
                        mensagemCriar.style.color = '#f00';
                    }
                });
            } else {
                // Fallback
                nomeSalaSelecionada = nomeSala;
                mostrarTelaSelecaoPlayer();
            }
        }
        
        // 3. LISTAR SALAS
        document.getElementById('btnVoltarSalas').addEventListener('click', () => {
            mostrarTela(telas.menu);
        });
        
        document.getElementById('btnAtualizarSalas').addEventListener('click', carregarSalas);
        
        function carregarSalas() {
            loadingSalas.style.display = 'block';
            listaSalasDiv.innerHTML = '';
            mensagemSalas.textContent = '';
            
            if (typeof window.carregarSalasFirebase === 'function') {
                window.carregarSalasFirebase((salas) => {
                    loadingSalas.style.display = 'none';
                    
                    if (salas.length === 0) {
                        mensagemSalas.textContent = 'Nenhuma sala encontrada. Crie uma nova sala!';
                        mensagemSalas.style.color = '#ff0';
                        return;
                    }
                    
                    salas.forEach(sala => {
                        const salaDiv = document.createElement('div');
                        salaDiv.className = 'sala-item';
                        salaDiv.innerHTML = `
                            <div>
                                <div class="sala-nome">${sala.nome}</div>
                                <div class="sala-info">Jogadores: ${sala.jogadores || 0}/4</div>
                            </div>
                            <div class="sala-info">‚Üí</div>
                        `;
                        
                        salaDiv.addEventListener('click', () => {
                            nomeSalaSelecionada = sala.nome;
                            mostrarTelaSelecaoPlayer();
                        });
                        
                        listaSalasDiv.appendChild(salaDiv);
                    });
                });
            } else {
                // Fallback com salas de exemplo
                setTimeout(() => {
                    loadingSalas.style.display = 'none';
                    mensagemSalas.textContent = 'Sistema de salas offline. Use "Criar Sala".';
                    mensagemSalas.style.color = '#ff0';
                }, 1000);
            }
        }
        
        // 4. SELE√á√ÉO DE PLAYER
        function mostrarTelaSelecaoPlayer() {
            nomeSalaAtual.textContent = nomeSalaSelecionada;
            subtituloSala.textContent = `Sala: ${nomeSalaSelecionada}`;
            playerSelecionado = null;
            mensagemPlayer.textContent = '';
            
            // Resetar sele√ß√£o
            document.querySelectorAll('.player-opcao').forEach(opcao => {
                opcao.classList.remove('selecionado');
            });
            
            // Verificar jogadores ocupados na sala
            if (typeof window.verificarJogadoresSala === 'function') {
                window.verificarJogadoresSala(nomeSalaSelecionada, (jogadoresOcupados) => {
                    document.querySelectorAll('.player-opcao').forEach(opcao => {
                        const playerNum = opcao.dataset.player;
                        if (jogadoresOcupados.includes(playerNum)) {
                            opcao.style.opacity = '0.5';
                            opcao.style.cursor = 'not-allowed';
                            opcao.title = 'Player j√° ocupado';
                        } else {
                            opcao.style.opacity = '1';
                            opcao.style.cursor = 'pointer';
                            opcao.title = '';
                        }
                    });
                });
            }
            
            mostrarTela(telas.selecaoPlayer);
        }
        
        document.getElementById('btnVoltarPlayer').addEventListener('click', () => {
            if (nomeSalaSelecionada) {
                mostrarTela(telas.listarSalas);
            } else {
                mostrarTela(telas.menu);
            }
        });
        
        // Selecionar player
        document.querySelectorAll('.player-opcao').forEach(opcao => {
            opcao.addEventListener('click', function() {
                if (this.style.opacity === '0.5') {
                    mensagemPlayer.textContent = 'Este player j√° est√° ocupado!';
                    mensagemPlayer.style.color = '#f00';
                    return;
                }
                
                document.querySelectorAll('.player-opcao').forEach(p => {
                    p.classList.remove('selecionado');
                });
                this.classList.add('selecionado');
                playerSelecionado = this.dataset.player;
                mensagemPlayer.textContent = '';
                
                document.getElementById('btnContinuarPersonagem').disabled = false;
            });
        });
        
        // Continuar para sele√ß√£o de personagem
        document.getElementById('btnContinuarPersonagem').addEventListener('click', () => {
            if (!playerSelecionado) {
                mensagemPlayer.textContent = 'Selecione um player primeiro!';
                mensagemPlayer.style.color = '#ff0';
                return;
            }
            
            nomeSalaAtualPersonagem.textContent = nomeSalaSelecionada;
            playerSelecionadoSpan.textContent = `Player ${playerSelecionado}`;
            subtituloSalaPersonagem.textContent = `Sala: ${nomeSalaSelecionada} | Player: ${playerSelecionado}`;
            personagemSelecionado = null;
            mensagemPersonagem.textContent = '';
            
            // Resetar sele√ß√£o
            document.querySelectorAll('.personagem-opcao').forEach(opcao => {
                opcao.classList.remove('selecionado');
            });
            
            mostrarTela(telas.selecaoPersonagem);
            document.getElementById('btnConfirmarPersonagem').disabled = true;
        });
        
        // 5. SELE√á√ÉO DE PERSONAGEM
        document.getElementById('btnVoltarPersonagem').addEventListener('click', () => {
            mostrarTela(telas.selecaoPlayer);
        });
        
        // Selecionar personagem
        document.querySelectorAll('.personagem-opcao').forEach(opcao => {
            opcao.addEventListener('click', function() {
                document.querySelectorAll('.personagem-opcao').forEach(p => {
                    p.classList.remove('selecionado');
                });
                this.classList.add('selecionado');
                personagemSelecionado = this.dataset.personagem;
                mensagemPersonagem.textContent = '';
                
                document.getElementById('btnConfirmarPersonagem').disabled = false;
            });
        });
        
        // Entrar na sala
        document.getElementById('btnConfirmarPersonagem').addEventListener('click', entrarNaSala);
        
        function entrarNaSala() {
            console.log('üéÆ Tentando entrar na sala:', {
                sala: nomeSalaSelecionada,
                player: playerSelecionado,
                personagem: personagemSelecionado
            });
            
            // 1. VALIDA√á√ïES INICIAIS
            if (!playerSelecionado) {
                mensagemPersonagem.textContent = 'Selecione um player primeiro!';
                mensagemPersonagem.style.color = '#ff0';
                return;
            }
            
            if (!personagemSelecionado) {
                mensagemPersonagem.textContent = 'Selecione um personagem!';
                mensagemPersonagem.style.color = '#ff0';
                return;
            }
            
            if (!nomeSalaSelecionada) {
                mensagemPersonagem.textContent = 'Nenhuma sala selecionada!';
                mensagemPersonagem.style.color = '#ff0';
                return;
            }
            
            // 2. MOSTRAR LOADING
            loadingEntrada.style.display = 'block';
            mensagemPersonagem.textContent = '';
            document.getElementById('btnConfirmarPersonagem').disabled = true;
            
            // 3. REGISTRAR NO FIREBASE (ou fallback)
            if (typeof window.registrarJogadorSala === 'function') {
                window.registrarJogadorSala(
                    nomeSalaSelecionada, 
                    playerSelecionado, 
                    personagemSelecionado, 
                    
                    function(sucesso, mensagem) {
                        // Esconder loading
                        loadingEntrada.style.display = 'none';
                        document.getElementById('btnConfirmarPersonagem').disabled = false;
                        
                        if (sucesso) {
                            console.log('‚úÖ Entrou na sala com sucesso');
                            
                            // Atualizar estado local
                            salaAtual = nomeSalaSelecionada;
                            
                            // SALVAR NO LOCALSTORAGE (para recupera√ß√£o)
                            try {
                                localStorage.setItem('pinic_ultima_sessao', JSON.stringify({
                                    sala: salaAtual,
                                    player: playerSelecionado,
                                    personagem: personagemSelecionado,
                                    timestamp: Date.now()
                                }));
                            } catch (e) {
                                console.log('‚ö†Ô∏è N√£o foi poss√≠vel salvar no localStorage');
                            }
                            
                            // Atualizar informa√ß√µes na tela do jogo
                            infoSalaJogo.innerHTML = `
                                <strong>üéÆ SALA:</strong> ${salaAtual}<br>
                                <strong>üë§ PLAYER:</strong> ${playerSelecionado}<br>
                                <strong>‚öîÔ∏è PERSONAGEM:</strong> ${personagemSelecionado}
                            `;
                            
                            // Iniciar sistema de heartbeat
                            try {
                                if (typeof iniciarHeartbeat === 'function') {
                                    iniciarHeartbeat();
                                } else {
                                    console.log('‚ö†Ô∏è Fun√ß√£o iniciarHeartbeat n√£o encontrada');
                                }
                            } catch (error) {
                                console.error('‚ùå Erro ao iniciar heartbeat:', error);
                            }
                            
                            // Iniciar o jogo principal
                            if (typeof window.inicializarJogoSala === 'function') {
                                window.inicializarJogoSala(
                                    nomeSalaSelecionada, 
                                    playerSelecionado, 
                                    personagemSelecionado
                                );
                            } else {
                                console.log('‚ö†Ô∏è Fun√ß√£o inicializarJogoSala n√£o encontrada');
                                // Fallback: mostrar mensagem
                                infoSalaJogo.innerHTML += '<br><br><small style="color:#ff0">Modo demonstra√ß√£o ativado</small>';
                            }
                            
                            // Mudar para tela do jogo
                            mostrarTela(telas.jogo);
                            
                            // Scroll para o topo (caso necess√°rio)
                            window.scrollTo(0, 0);
                            
                        } else {
                            // ERRO: mostrar mensagem
                            console.error('‚ùå Falha ao entrar na sala:', mensagem);
                            mensagemPersonagem.textContent = 'Erro: ' + mensagem;
                            mensagemPersonagem.style.color = '#f00';
                            
                            // Manter na mesma tela para tentar novamente
                            mostrarTela(telas.selecaoPersonagem);
                        }
                    }
                );
                
            } else {
                // 4. FALLBACK (modo offline/demonstra√ß√£o)
                console.log('üî∂ Modo demonstra√ß√£o (Firebase n√£o dispon√≠vel)');
                
                setTimeout(() => {
                    loadingEntrada.style.display = 'none';
                    document.getElementById('btnConfirmarPersonagem').disabled = false;
                    
                    salaAtual = nomeSalaSelecionada;
                    
                    // Atualizar informa√ß√µes
                    infoSalaJogo.innerHTML = `
                        <strong>üéÆ SALA:</strong> ${salaAtual}<br>
                        <strong>üë§ PLAYER:</strong> ${playerSelecionado}<br>
                        <strong>‚öîÔ∏è PERSONAGEM:</strong> ${personagemSelecionado}<br>
                        <br>
                        <small style="color:#ff0">‚ö†Ô∏è Modo demonstra√ß√£o (sem Firebase)</small>
                    `;
                    
                    // Iniciar heartbeat mesmo no modo demo
                    if (typeof iniciarHeartbeat === 'function') {
                        iniciarHeartbeat();
                    }
                    
                    // Tentar iniciar jogo (modo single player)
                    if (typeof window.inicializarJogoSala === 'function') {
                        window.inicializarJogoSala(nomeSalaSelecionada, playerSelecionado, personagemSelecionado);
                    }
                    
                    mostrarTela(telas.jogo);
                    
                    // Feedback
                    setTimeout(() => {
                        alert('üéÆ Modo demonstra√ß√£o ativado!\n\nO sistema de salas multiplayer requer Firebase.\nPara jogar com amigos, configure o Firebase.');
                    }, 500);
                    
                }, 1500);
            }
        }
        
        // 6. JOGO PRINCIPAL
        document.getElementById('btnSairSala').addEventListener('click', sairDaSala);
        
        function sairDaSala() {
            console.log('üö™ Saindo da sala:', { 
                sala: salaAtual, 
                player: playerSelecionado 
            });
            
            // 1. PARAR HEARTBEAT (se estiver rodando)
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
                console.log('üíî Heartbeat parado');
            }
            
            // 2. NOTIFICAR OUTROS JOGADORES (se estiver numa sala)
            if (salaAtual && playerSelecionado) {
                // Disparar evento personalizado para o jogo
                const evento = new CustomEvent('sairSala', {
                    detail: { 
                        sala: salaAtual, 
                        player: playerSelecionado,
                        timestamp: Date.now()
                    }
                });
                window.dispatchEvent(evento);
                
                // Remover jogador da sala via Firebase (se a fun√ß√£o existir)
                if (typeof window.removerJogadorSala === 'function') {
                    window.removerJogadorSala(salaAtual, playerSelecionado);
                } else {
                    console.log('‚ö†Ô∏è Fun√ß√£o removerJogadorSala n√£o encontrada');
                }
            }
            
            // 3. PARAR O JOGO (se estiver rodando)
            if (typeof window.pararJogo === 'function') {
                window.pararJogo();
            }
            
            // 4. RESETAR TODAS AS VARI√ÅVEIS DE ESTADO
            const salaAntiga = salaAtual; // Guardar para log
            
            salaAtual = '';
            playerSelecionado = null;
            personagemSelecionado = null;
            nomeSalaSelecionada = '';
            jogadoresNaSala = {};
            
            // 5. LIMPAR A TELA
            infoSalaJogo.innerHTML = '';
            jogadoresSala.innerHTML = '';
            
            // 6. MOSTRAR MENU PRINCIPAL
            mostrarTela(telas.menu);
            
            // 7. FEEDBACK VISUAL (opcional)
            console.log('‚úÖ Saiu da sala:', salaAntiga);
            
            // 8. LIMPAR LOCALSTORAGE (se estiver usando)
            try {
                localStorage.removeItem('pinic_ultima_sessao');
            } catch (e) {
                // Ignorar erro
            }
        }
        
        // Fun√ß√£o para atualizar lista de jogadores na sala (chamada pelo Firebase)
        window.atualizarJogadoresSala = function(jogadores) {
            jogadoresNaSala = jogadores;
            
            let html = '<strong>üë• Jogadores na Sala:</strong><br>';
            let count = 0;
            
            for (const [playerId, dados] of Object.entries(jogadores)) {
                count++;
                const eu = (playerSelecionado && playerId === `p${playerSelecionado}`);
                const icon = dados.personagem === 'cocozin' ? 'üí©' : 
                            dados.personagem === 'ratazana' ? 'üêÄ' : 
                            dados.personagem === 'peidov√©lio' ? 'üí®' : 'üë§';
                
                html += `
                    <div class="jogador-item ${eu ? 'eu' : ''}">
                        <span>${icon} ${playerId.toUpperCase()}</span>
                        <span>${dados.personagem || 'Escolhendo...'}</span>
                        <span>${dados.vida || 100}‚ù§Ô∏è</span>
                    </div>
                `;
            }
            
            if (count === 0) {
                html += '‚åõ Aguardando jogadores...';
            } else {
                html += `<br><small>${count} jogador(es) na sala</small>`;
            }
            
            jogadoresSala.innerHTML = html;
            
            // Se n√£o h√° mais jogadores na sala e estamos sozinhos, voltar ao menu
            if (count === 1 && playerSelecionado) {
                const unicoJogador = Object.keys(jogadores)[0];
                if (unicoJogador !== `p${playerSelecionado}`) {
                    // Todos sa√≠ram, s√≥ restou outro jogador
                    console.log('Todos os outros jogadores sa√≠ram');
                }
            }
        };
        
        // Evento para quando recebermos um sinal de que o jogador foi removido
        window.addEventListener('jogadorRemovido', function(e) {
            const { sala, player } = e.detail;
            
            if (sala === salaAtual && `p${player}` === `p${playerSelecionado}`) {
                console.log('Voc√™ foi removido da sala');
                
                // Resetar estado
                salaAtual = '';
                playerSelecionado = null;
                personagemSelecionado = null;
                nomeSalaSelecionada = '';
                jogadoresNaSala = {};
                
                // Limpar informa√ß√µes da tela
                infoSalaJogo.innerHTML = '';
                jogadoresSala.innerHTML = '';
                
                // Mostrar mensagem
                alert('Voc√™ foi removido da sala. Voltando ao menu...');
                
                mostrarTela(telas.menu);
            }
        });
        
        // Configurar evento para quando a p√°gina for fechada
        window.addEventListener('beforeunload', function() {
            if (salaAtual && playerSelecionado) {
                // Tentar remover jogador antes de fechar
                if (typeof window.removerJogadorSala === 'function') {
                    // Usar sendBeacon para garantir que a requisi√ß√£o seja feita
                    const dados = JSON.stringify({
                        sala: salaAtual,
                        player: playerSelecionado,
                        timestamp: Date.now()
                    });
                    
                    try {
                        // Tentar enviar uma √∫ltima requisi√ß√£o
                        navigator.sendBeacon(`/api/remover-jogador?dados=${encodeURIComponent(dados)}`);
                    } catch (e) {
                        // Fallback: tentar remover via Firebase
                        window.removerJogadorSala(salaAtual, playerSelecionado);
                    }
                }
            }
        });
        
        // Iniciar no menu
        mostrarTela(telas.menu);
        
        // Verificar se h√° sess√£o antiga pendente
        try {
            const sessao = localStorage.getItem('pinic_ultima_sessao');
            if (sessao) {
                const dados = JSON.parse(sessao);
                const agora = Date.now();
                
                // Se a sess√£o tem menos de 5 minutos, mostrar alerta
                if (agora - dados.timestamp < 300000) {
                    console.log('Sess√£o recente detectada. Verificando se h√° jogadores pendentes...');
                }
            }
        } catch (e) {
            // Ignorar erro
        }
    });
    </script>
    <script>
// Script de inicializa√ß√£o final
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Sistema Pinic Fighter inicializando...');
    
    // Verificar se todos os elementos necess√°rios existem
    const canvas = document.getElementById('game');
    if (!canvas) {
        console.error('‚ùå Canvas n√£o encontrado!');
        return;
    }
    
    // Verificar se imagens existem
    const logo = document.querySelector('.logo img');
    if (logo) {
        logo.onerror = function() {
            console.warn('‚ö†Ô∏è Logo n√£o encontrada, usando fallback');
            this.style.display = 'none';
        };
    }
    
    // Configurar evento de teclas para prevenir comportamento padr√£o
    document.addEventListener('keydown', function(e) {
        // Prevenir scroll com setas
        if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
            e.preventDefault();
        }
    });
    
    // Fun√ß√£o de debug para verificar estado do jogo
    window.debugJogo = function() {
        console.log('üîç DEBUG DO JOGO:');
        console.log('- Canvas:', document.getElementById('game') ? 'OK' : 'FALTA');
        console.log('- Firebase:', typeof firebase !== 'undefined' ? 'OK' : 'FALTA');
        console.log('- Keys:', typeof keys !== 'undefined' ? 'OK' : 'FALTA');
        console.log('- Sistema de salas:', typeof window.verificarECriarSala === 'function' ? 'OK' : 'FALTA');
        console.log('- Personagens:', typeof criarPersonagem === 'function' ? 'OK' : 'FALTA');
    };
    
    // Testar modo demo ap√≥s 3 segundos se nada acontecer
    setTimeout(function() {
        if (!document.querySelector('#jogoPrincipal').style.display === 'flex') {
            console.log('üîÑ Nenhum jogo iniciado, modo demo dispon√≠vel');
        }
    }, 3000);
    
    console.log('‚úÖ Sistema inicializado com sucesso!');
    console.log('üí° Dica: Pressione F12 e digite debugJogo() para verificar estado');
});
</script>
</body>
</html>




