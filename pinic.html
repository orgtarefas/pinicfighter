<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Pinico Fighter</title>

<style>
body {
    margin: 0;
    background: #111;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    font-family: Arial;
    color: white;
}

.logo img {
    max-width: 220px;
    margin-bottom: 8px;
}

canvas {
    border: 3px solid #0f0;
}
</style>
</head>

<body>

<div class="logo">
    <img src="imagens/logo.png">
</div>

<canvas id="game" width="900" height="400"></canvas>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ================= CONFIGURA√á√ïES GLOBAIS =================
const CONFIG = {
    GRAVIDADE: 0.8,
    CHAO: 320,
    LIM_ESQ: 40,
    LIM_DIR: 860,
    VELOCIDADE: 4,
    TAMANHO_COCO: 80,
    DANO_SOCO: 8,
    DANO_CHUTE: 15,
    DANO_BOMBA: 20
};

// ================= FIREBASE ================= 
firebase.initializeApp({
    apiKey: "AIzaSyDy_gqNrFR7KmMonXp7KfgRc15UVj0g3Nw",
    authDomain: "pinico-fighter.firebaseapp.com",
    databaseURL: "https://pinico-fighter-default-rtdb.firebaseio.com",
    projectId: "pinico-fighter",
    storageBucket: "pinico-fighter.firebasestorage.app",
    messagingSenderId: "152199667347",
    appId: "1:152199667347:web:9c74188c88bdee8633f766"
});

const db = firebase.database();

// ================= M√ìDULO: UTILITIES =================
const Utils = {
    colisao(a, b) {
        return a.x < b.x + b.w && 
               a.x + a.w > b.x && 
               a.y < b.y + b.h && 
               a.y + a.h > b.y;
    },
    
    criarParticulas(ctx, x, y, quantidade, cor) {
        for (let i = 0; i < quantidade; i++) {
            const particula = {
                x: x + Math.random() * 20 - 10,
                y: y + Math.random() * 20 - 10,
                vx: Math.random() * 4 - 2,
                vy: Math.random() * -3 - 1,
                tamanho: Math.random() * 3 + 1,
                vida: 20,
                cor: cor
            };
            
            ctx.fillStyle = particula.cor;
            ctx.beginPath();
            ctx.arc(particula.x, particula.y, particula.tamanho, 0, Math.PI * 2);
            ctx.fill();
        }
    },
    
    desenharBarra(ctx, x, y, largura, altura, valor, valorMax, corFundo, corBarra) {
        // Fundo
        ctx.fillStyle = corFundo;
        ctx.fillRect(x, y, largura, altura);
        
        // Barra
        ctx.fillStyle = corBarra;
        const larguraAtual = (valor / valorMax) * largura;
        ctx.fillRect(x, y, larguraAtual, altura);
        
        // Borda
        ctx.strokeStyle = "white";
        ctx.lineWidth = 2;
        ctx.strokeRect(x, y, largura, altura);
    }
};

// ================= M√ìDULO: COCO PROJ√âTIL =================
class CocoProjetil {
    constructor(x, y, direcao, cor, donoId) {
        this.x = x;
        this.y = y;
        this.direcao = direcao;
        this.cor = cor;
        this.donoId = donoId;
        this.velX = direcao * 8;
        this.velY = -15;
        this.raio = 12;
        this.ativo = true;
        this.tempoVida = 100;
    }
    
    atualizar() {
        if (!this.ativo) return;
        
        this.x += this.velX;
        this.y += this.velY;
        this.velY += CONFIG.GRAVIDADE;
        this.tempoVida--;
        
        if (this.x < 0 || this.x > 900 || this.y > CONFIG.CHAO + 50 || this.tempoVida <= 0) {
            this.ativo = false;
        }
    }
    
    desenhar(ctx) {
        if (!this.ativo) return;
        
        // Coco
        ctx.fillStyle = this.cor;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.raio, 0, Math.PI * 2);
        ctx.fill();
        
        // Detalhes
        ctx.fillStyle = "#8B4513";
        ctx.beginPath();
        ctx.arc(this.x - 4, this.y - 3, 3, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(this.x + 4, this.y, 3, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(this.x, this.y + 4, 3, 0, Math.PI * 2);
        ctx.fill();
        
        // Trajet√≥ria
        ctx.strokeStyle = "rgba(255, 255, 0, 0.3)";
        ctx.lineWidth = 2;
        ctx.setLineDash([3, 3]);
        ctx.beginPath();
        ctx.moveTo(this.x, this.y);
        ctx.lineTo(this.x - this.velX * 2, this.y - this.velY * 2);
        ctx.stroke();
        ctx.setLineDash([]);
    }
    
    hitbox() {
        return {
            x: this.x - this.raio,
            y: this.y - this.raio,
            w: this.raio * 2,
            h: this.raio * 2
        };
    }
}

// ================= M√ìDULO: LUTADOR COC√î =================
class LutadorCoco {
    constructor(x, cor, corSapato, controles, direcao, id) {
        this.id = id;
        this.inicialX = x;
        this.x = x;
        this.y = CONFIG.CHAO;
        this.vy = 0;
        this.cor = cor;
        this.corSapato = corSapato;
        this.tamanho = CONFIG.TAMANHO_COCO;
        this.vel = CONFIG.VELOCIDADE;
        this.dir = direcao;
        
        // Estados
        this.pulando = false;
        this.atacando = false;
        this.chutando = false;
        this.descendoRapido = false;
        this.transformado = false; // NOVO: estado de transforma√ß√£o em bola
        
        // Temporizadores
        this.tempoAtaque = 0;
        this.tempoChute = 0;
        this.tempoTransformacao = 0; // NOVO: tempo da transforma√ß√£o
        
        // Atributos
        this.vida = 100;
        this.vivo = true;
        
        // Controles
        this.ctrl = controles;
        this.ultimoDano = 0;
        this.olhosAbertos = true;
        this.tempoPiscar = 0;
        
        // Sapatos
        this.sapatoX = 0;
        this.sapatoY = 0;
        
        // Sistema de poder
        this.cdPoder = 0;
        this.cocosAtivos = [];
        this.cargaPoder = 0;
        this.maxCarga = 30;
    }

    // ================= CONTROLES =================
    mover(keys, jogoTerminou) {
        if (!this.vivo || jogoTerminou) return;
        
        if (keys[this.ctrl.esq]) { 
            this.x -= this.vel; 
            this.dir = -1;
        }
        if (keys[this.ctrl.dir]) { 
            this.x += this.vel; 
            this.dir = 1;
        }
        
        this.x = Math.max(CONFIG.LIM_ESQ, Math.min(CONFIG.LIM_DIR, this.x));
    }

    pular(keys, jogoTerminou) {
        if (!this.vivo || jogoTerminou) return;
        
        // Pulo normal
        if (keys[this.ctrl.pulo] && !this.pulando && !this.chutando) {
            this.vy = -18;
            this.pulando = true;
            this.descendoRapido = false;
            this.transformado = false;
        }
        
        // Poder: Bomba de Coc√¥
        const teclaBaixo = this.id === "p1" ? "s" : "ArrowDown";
        if (this.pulando && keys[teclaBaixo] && this.cdPoder <= 0) {
            this.ativarDescidaRapida();
        } else if (this.descendoRapido) {
            this.desativarDescidaRapida();
        }
    }
    
    ativarDescidaRapida() {
        this.descendoRapido = true;
        this.transformado = true; // Transforma em bola
        this.tempoTransformacao = 10; // Mant√©m transforma√ß√£o por 10 frames
        this.vy = 20; // Desce r√°pido
        this.cargaPoder++;
        
        // Olhos abertos durante a descida
        this.olhosAbertos = true;
    }
    
    desativarDescidaRapida() {
        this.descendoRapido = false;
        this.cargaPoder = 0;
    }

    atacar(keys, inimigo, jogoTerminou) {
        if (!this.vivo || !inimigo.vivo || jogoTerminou) return;

        // Soco
        if (keys[this.ctrl.atk] && !this.atacando && !this.chutando) {
            this.atacando = true;
            this.tempoAtaque = 8;
            this.olhosAbertos = false;

            const hit = {
                x: this.x + this.dir * 50,
                y: this.y - 40,
                w: 45,
                h: 35
            };

            if (Utils.colisao(hit, inimigo.hitbox())) {
                inimigo.receberDano(CONFIG.DANO_SOCO);
            }
        }

        // Chute
        const teclaChute = this.id === "p1" ? "c" : ".";
        if (keys[teclaChute] && !this.chutando && !this.atacando) {
            this.chutando = true;
            this.tempoChute = 12;
            
            this.sapatoX = this.x + this.dir * 20;
            this.sapatoY = this.y + 10;

            const hit = {
                x: this.x + this.dir * 60,
                y: this.y + 5,
                w: 50,
                h: 30
            };

            if (Utils.colisao(hit, inimigo.hitbox())) {
                inimigo.receberDano(CONFIG.DANO_CHUTE);
            }
        }

        // Atualiza temporizadores
        this.atualizarTemporizadores();
    }
    
    atualizarTemporizadores() {
        // Atualiza temporizador de transforma√ß√£o
        if (this.transformado && this.tempoTransformacao > 0) {
            this.tempoTransformacao--;
            if (this.tempoTransformacao <= 0) {
                this.transformado = false;
            }
        }
        
        // Atualiza ataque
        if (this.atacando && --this.tempoAtaque <= 0) {
            this.atacando = false;
            this.olhosAbertos = true;
        }
        
        // Atualiza chute
        if (this.chutando) {
            this.tempoChute--;
            if (this.tempoChute > 8) {
                this.sapatoX += this.dir * 8;
                this.sapatoY -= 2;
            } else if (this.tempoChute > 4) {
                this.sapatoY += 1;
            } else if (this.tempoChute > 0) {
                this.sapatoX -= this.dir * 6;
                this.sapatoY += 3;
            } else {
                this.chutando = false;
            }
        }
    }

    // ================= SISTEMA DE PODER =================
    atualizarCocos(inimigo) {
        // Atualiza coc√¥s existentes
        for (let i = this.cocosAtivos.length - 1; i >= 0; i--) {
            const coco = this.cocosAtivos[i];
            coco.atualizar();
            
            // Verifica colis√£o
            if (coco.ativo && inimigo.vivo && Utils.colisao(coco.hitbox(), inimigo.hitbox())) {
                inimigo.receberDano(CONFIG.DANO_BOMBA);
                coco.ativo = false;
            }
            
            // Remove coc√¥s inativos
            if (!coco.ativo) {
                this.cocosAtivos.splice(i, 1);
            }
        }
        
        // Atualiza cooldown
        if (this.cdPoder > 0) {
            this.cdPoder--;
        }
    }
    
    lancarCoco() {
        if (this.cdPoder > 0) return;
        
        const coco = new CocoProjetil(
            this.x,
            this.y - 30,
            this.dir,
            this.cor,
            this.id
        );
        
        this.cocosAtivos.push(coco);
        this.cdPoder = 60; // 1 segundo de cooldown
        
        return coco;
    }

    // ================= F√çSICA =================
    fisica() {
        if (!this.vivo) { 
            this.y = CONFIG.CHAO + 10; 
            this.vy = 0;
            return; 
        }
        
        this.y += this.vy;
        
        // Aplica gravidade normal ou descida r√°pida
        if (!this.descendoRapido) {
            this.vy += CONFIG.GRAVIDADE;
        }
        
        // Verifica se bateu no ch√£o
        if (this.y >= CONFIG.CHAO) {
            const bateuComForca = this.vy > 10 && this.descendoRapido && this.cargaPoder > 10;
            
            this.y = CONFIG.CHAO;
            this.vy = 0;
            this.pulando = false;
            this.descendoRapido = false;
            this.transformado = false; // Volta ao normal ao tocar o ch√£o
            
            // Lan√ßa coc√¥ se bateu com for√ßa
            if (bateuComForca && this.cdPoder <= 0) {
                const coco = this.lancarCoco();
                return coco; // Retorna o coc√¥ para sincroniza√ß√£o
            }
            
            this.cargaPoder = 0;
        }
        
        return null;
    }

    // ================= DANO =================
    receberDano(v) {
        if (!this.vivo) return;
        
        const agora = Date.now();
        if (agora - this.ultimoDano < 500) return;
        this.ultimoDano = agora;
        
        this.vida -= v;
        if (this.vida <= 0) {
            this.vida = 0;
            this.vivo = false;
            this.y = CONFIG.CHAO + 10;
            this.vy = 0;
        }
        
        this.olhosAbertos = false;
        setTimeout(() => this.olhosAbertos = true, 200);
    }

    // ================= DESENHO =================
    desenhar(ctx) {
        // Atualiza piscar de olhos
        this.atualizarPiscar();
        
        if (!this.vivo) {
            this.desenharMorto(ctx);
            return;
        }
        
        // Desenha transformado ou normal
        if (this.transformado) {
            this.desenharTransformado(ctx);
        } else {
            this.desenharNormal(ctx);
        }
        
        // Desenha elementos extras
        this.desenharExtras(ctx);
    }
    
    atualizarPiscar() {
        this.tempoPiscar++;
        if (this.tempoPiscar > 100) {
            this.olhosAbertos = !this.olhosAbertos;
            this.tempoPiscar = 0;
        }
        if (Math.random() < 0.005) {
            this.olhosAbertos = false;
            setTimeout(() => this.olhosAbertos = true, 100);
        }
    }
    
    desenharNormal(ctx) {
        // Corpo do coc√¥ (4 partes)
        ctx.fillStyle = this.cor;
        const raioBase = this.tamanho / 2;
        
        // Base
        ctx.beginPath();
        ctx.ellipse(this.x, this.y - 10, raioBase, raioBase * 0.6, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // Parte m√©dia
        ctx.beginPath();
        ctx.ellipse(this.x, this.y - raioBase, raioBase * 0.7, raioBase * 0.5, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // Parte superior
        ctx.beginPath();
        ctx.ellipse(this.x, this.y - raioBase * 1.5, raioBase * 0.5, raioBase * 0.4, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // Topo
        ctx.beginPath();
        ctx.ellipse(this.x, this.y - raioBase * 1.8, raioBase * 0.3, raioBase * 0.25, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // Detalhes
        this.desenharDetalhes(ctx, raioBase);
        
        // Sapatos
        this.desenharSapatos(ctx);
        
        // Bra√ßos
        this.desenharBracos(ctx);
        
        // Face
        this.desenharFace(ctx);
    }
    
    // NOVO: Desenha transformado em bola
    desenharTransformado(ctx) {
        // Desenha como uma bola de coc√¥
        const raioBola = this.tamanho * 0.6; // Um pouco menor que o normal
        
        // Corpo esf√©rico
        ctx.fillStyle = this.cor;
        ctx.beginPath();
        ctx.arc(this.x, this.y - raioBola, raioBola, 0, Math.PI * 2);
        ctx.fill();
        
        // Detalhes da bola
        ctx.fillStyle = "#8B4513";
        for(let i = 0; i < 8; i++) {
            const angulo = (i / 8) * Math.PI * 2;
            const detalheX = this.x + Math.cos(angulo) * raioBola * 0.7;
            const detalheY = this.y - raioBola + Math.sin(angulo) * raioBola * 0.7;
            ctx.beginPath();
            ctx.arc(detalheX, detalheY, 4, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // Sapatos (menores e mais pr√≥ximos)
        this.desenharSapatosTransformados(ctx, raioBola);
        
        // Olhos (sempre abertos durante transforma√ß√£o)
        this.desenharOlhosTransformados(ctx, raioBola);
        
        // Boca (express√£o de determina√ß√£o)
        this.desenharBocaTransformada(ctx, raioBola);
        
        // Efeito de velocidade
        if (this.descendoRapido) {
            this.desenharEfeitoVelocidade(ctx);
        }
    }
    
    desenharSapatosTransformados(ctx, raioBola) {
        const sapatoY = this.y + 5;
        const sapatoX1 = this.x - raioBola * 0.4;
        const sapatoX2 = this.x + raioBola * 0.4;
        
        this.desenharSapatoUnico(ctx, sapatoX1, sapatoY, false);
        this.desenharSapatoUnico(ctx, sapatoX2, sapatoY, false);
    }
    
    desenharOlhosTransformados(ctx, raioBola) {
        const olhoY = this.y - raioBola * 1.2;
        
        // Olhos sempre abertos e grandes durante transforma√ß√£o
        ctx.fillStyle = "white";
        ctx.beginPath();
        ctx.arc(this.x - raioBola * 0.3, olhoY, raioBola * 0.15, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(this.x + raioBola * 0.3, olhoY, raioBola * 0.15, 0, Math.PI * 2);
        ctx.fill();
        
        // Pupilas (olhando para baixo durante descida)
        ctx.fillStyle = "black";
        const pupilaOffset = this.descendoRapido ? 2 : 0;
        ctx.beginPath();
        ctx.arc(this.x - raioBola * 0.3, olhoY + pupilaOffset, raioBola * 0.08, 0, Math.PI * 2);
        ctx.fill();
        ctx.beginPath();
        ctx.arc(this.x + raioBola * 0.3, olhoY + pupilaOffset, raioBola * 0.08, 0, Math.PI * 2);
        ctx.fill();
    }
    
    desenharBocaTransformada(ctx, raioBola) {
        const bocaY = this.y - raioBola * 0.8;
        
        ctx.strokeStyle = "black";
        ctx.lineWidth = 3;
        
        if (this.descendoRapido) {
            // Boca determinada durante descida
            ctx.beginPath();
            ctx.arc(this.x, bocaY, raioBola * 0.2, 0.1, Math.PI - 0.1);
            ctx.stroke();
        } else {
            // Boca normal
            ctx.beginPath();
            ctx.arc(this.x, bocaY, raioBola * 0.25, 0.2, Math.PI - 0.2);
            ctx.stroke();
        }
    }
    
    desenharEfeitoVelocidade(ctx) {
        // Linhas de velocidade
        ctx.strokeStyle = "rgba(255, 255, 0, 0.7)";
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 3]);
        
        for(let i = 0; i < 3; i++) {
            ctx.beginPath();
            ctx.moveTo(this.x - 20 + i * 10, this.y + 30);
            ctx.lineTo(this.x - 50 + i * 10, this.y + 50);
            ctx.stroke();
        }
        
        ctx.setLineDash([]);
    }
    
    desenharDetalhes(ctx, raioBase) {
        ctx.fillStyle = "#8B4513";
        
        // Detalhes na base
        for(let i = 0; i < 7; i++) {
            const angulo = (i / 7) * Math.PI * 2;
            const detalheX = this.x + Math.cos(angulo) * raioBase * 0.7;
            const detalheY = this.y - 10 + Math.sin(angulo) * raioBase * 0.4;
            ctx.beginPath();
            ctx.ellipse(detalheX, detalheY, 4, 3, 0, 0, Math.PI * 2);
            ctx.fill();
        }
    }
    
    desenharSapatos(ctx) {
        if (this.chutando) {
            this.desenharSapatoUnico(ctx, this.sapatoX, this.sapatoY, true);
            const sapatoNormalX = this.x + (this.dir > 0 ? -15 : 15);
            this.desenharSapatoUnico(ctx, sapatoNormalX, this.y + 15, false);
        } else {
            const sapatoEsqX = this.x - 15;
            const sapatoDirX = this.x + 15;
            
            if (this.pulando) {
                this.desenharSapatoUnico(ctx, sapatoEsqX + 5, this.y + 5, false);
                this.desenharSapatoUnico(ctx, sapatoDirX - 5, this.y + 5, false);
            } else {
                this.desenharSapatoUnico(ctx, sapatoEsqX, this.y + 15, false);
                this.desenharSapatoUnico(ctx, sapatoDirX, this.y + 15, false);
            }
        }
    }
    
    desenharSapatoUnico(ctx, x, y, chutando) {
        const tamanho = chutando ? 25 : 20;
        const altura = chutando ? 12 : 10;
        
        // Sapato
        ctx.fillStyle = this.corSapato;
        ctx.beginPath();
        ctx.ellipse(x, y, tamanho, altura, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // Detalhe
        const corDetalhe = this.corSapato === "cyan" ? "#00aaff" : "#ff4444";
        ctx.fillStyle = corDetalhe;
        ctx.beginPath();
        ctx.ellipse(x + (this.dir > 0 ? 8 : -8), y, tamanho * 0.6, altura * 0.7, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // Sola
        ctx.fillStyle = "#333";
        ctx.beginPath();
        ctx.ellipse(x, y + altura - 2, tamanho * 0.9, 3, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // Efeito de chute
        if (chutando) {
            ctx.strokeStyle = "yellow";
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            for(let i = 0; i < 3; i++) {
                ctx.moveTo(x - this.dir * 20 - i * 5, y);
                ctx.lineTo(x - this.dir * 40 - i * 10, y);
            }
            ctx.stroke();
            ctx.setLineDash([]);
        }
    }
    
    desenharBracos(ctx) {
        ctx.strokeStyle = this.cor;
        ctx.lineWidth = 10;
        
        if (this.atacando) {
            // Bra√ßo atacante
            const bracoX = this.x + this.dir * 60;
            const bracoY = this.y - 40;
            
            ctx.beginPath();
            ctx.moveTo(this.x + this.dir * 20, this.y - 40);
            ctx.lineTo(bracoX, bracoY);
            ctx.stroke();
            
            // Punho
            ctx.fillStyle = this.cor;
            ctx.beginPath();
            ctx.arc(bracoX, bracoY, 15, 0, Math.PI * 2);
            ctx.fill();
            
            // Outro bra√ßo
            ctx.beginPath();
            ctx.moveTo(this.x - this.dir * 20, this.y - 40);
            ctx.lineTo(this.x - this.dir * 45, this.y - 35);
            ctx.stroke();
        } else {
            // Bra√ßos normais
            const offsetPulo = this.pulando ? -15 : 0;
            ctx.beginPath();
            ctx.moveTo(this.x - 20, this.y - 40);
            ctx.lineTo(this.x - 50, this.y - 30 + offsetPulo);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(this.x + 20, this.y - 40);
            ctx.lineTo(this.x + 50, this.y - 30 + offsetPulo);
            ctx.stroke();
        }
    }
    
    desenharFace(ctx) {
        this.desenharOlhos(ctx);
        this.desenharBoca(ctx);
    }
    
    desenharOlhos(ctx) {
        const olhoY = this.y - this.tamanho * 0.9;
        
        if (this.olhosAbertos) {
            // Olhos brancos
            ctx.fillStyle = "white";
            ctx.beginPath();
            ctx.arc(this.x - 15, olhoY, 8, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(this.x + 15, olgoY, 8, 0, Math.PI * 2);
            ctx.fill();
            
            // Pupilas
            ctx.fillStyle = "black";
            let pupilaX = this.dir * 2;
            if (this.atacando || this.chutando) pupilaX = this.dir * 4;
            if (this.pulando) pupilaX = 0;
            
            ctx.beginPath();
            ctx.arc(this.x - 15 + pupilaX, olgoY, 4, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(this.x + 15 + pupilaX, olgoY, 4, 0, Math.PI * 2);
            ctx.fill();
            
            // Brilho
            ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
            ctx.beginPath();
            ctx.arc(this.x - 15 + pupilaX - 2, olgoY - 2, 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(this.x + 15 + pupilaX - 2, olgoY - 2, 2, 0, Math.PI * 2);
            ctx.fill();
        } else {
            // Olhos fechados
            ctx.strokeStyle = "black";
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(this.x - 23, olgoY);
            ctx.lineTo(this.x - 7, olgoY);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(this.x + 7, olgoY);
            ctx.lineTo(this.x + 23, olgoY);
            ctx.stroke();
        }
    }
    
    desenharBoca(ctx) {
        const bocaY = this.y - this.tamanho * 0.7;
        ctx.strokeStyle = "black";
        ctx.lineWidth = 4;
        
        if (this.atacando) {
            ctx.beginPath();
            ctx.arc(this.x, bocaY, 12, 0, Math.PI);
            ctx.stroke();
        } else if (this.chutando) {
            ctx.beginPath();
            ctx.moveTo(this.x - 10, bocaY);
            ctx.lineTo(this.x + 10, bocaY);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(this.x - 8, bocaY + 3);
            ctx.lineTo(this.x + 8, bocaY + 3);
            ctx.stroke();
        } else if (this.pulando) {
            ctx.beginPath();
            ctx.arc(this.x, bocaY, 8, 0, Math.PI * 2);
            ctx.stroke();
        } else {
            ctx.beginPath();
            ctx.arc(this.x, bocaY, 10, 0.2, Math.PI - 0.2);
            ctx.stroke();
        }
    }
    
    desenharExtras(ctx) {
        // Desenha coc√¥s ativos
        for (const coco of this.cocosAtivos) {
            coco.desenhar(ctx);
        }
        
        // Indicador de carregamento
        if (this.descendoRapido && this.cargaPoder > 0) {
            this.desenharIndicadorPoder(ctx);
        }
        
        // Indicador de cooldown
        if (this.cdPoder > 0) {
            this.desenharCooldown(ctx);
        }
    }
    
    desenharIndicadorPoder(ctx) {
        const porcentagem = Math.min(this.cargaPoder / this.maxCarga, 1);
        const largura = 40;
        const altura = 6;
        const x = this.x - largura / 2;
        const y = this.y - this.tamanho - 30;
        
        // Barra
        Utils.desenharBarra(ctx, x, y, largura, altura, this.cargaPoder, this.maxCarga, "#333", porcentagem >= 1 ? "#ff00ff" : "#00ff00");
        
        // Texto
        ctx.fillStyle = "white";
        ctx.font = "10px Arial";
        ctx.textAlign = "center";
        ctx.fillText("BOMBA!", this.x, y - 5);
    }
    
    desenharCooldown(ctx) {
        const porcentagem = this.cdPoder / 60;
        const raio = 15;
        const x = this.x;
        const y = this.y - this.tamanho - 50;
        
        // C√≠rculo
        ctx.strokeStyle = "#ff4444";
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(x, y, raio, -Math.PI/2, (-Math.PI/2) + (Math.PI * 2 * (1 - porcentagem)), true);
        ctx.stroke();
        
        // Texto
        ctx.fillStyle = "white";
        ctx.font = "10px Arial";
        ctx.textAlign = "center";
        ctx.fillText(Math.ceil(this.cdPoder / 60 * 10) + "s", x, y + 3);
    }
    
    desenharMorto(ctx) {
        // Corpo achatado
        ctx.fillStyle = this.cor;
        const raioMorto = this.tamanho / 2;
        
        ctx.beginPath();
        ctx.ellipse(this.x, this.y - 10, raioMorto, raioMorto * 0.4, 0, 0, Math.PI * 2);
        ctx.fill();
        
        // Detalhes
        ctx.fillStyle = "#8B4513";
        for(let i = 0; i < 5; i++) {
            ctx.beginPath();
            ctx.ellipse(this.x - 20 + i * 10, this.y - 10, 5, 3, 0, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // Sapatos ca√≠dos
        this.desenharSapatoUnico(ctx, this.x - 25, this.y + 25, false);
        this.desenharSapatoUnico(ctx, this.x + 25, this.y + 25, false);
        
        // Olhos em X
        ctx.strokeStyle = "black";
        ctx.lineWidth = 4;
        const olgoY = this.y - this.tamanho * 0.6;
        
        for(let i = 0; i < 2; i++) {
            const offset = i * 20;
            ctx.beginPath();
            ctx.moveTo(this.x - 20 + offset, olgoY - 5);
            ctx.lineTo(this.x - 10 + offset, olgoY + 5);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(this.x - 10 + offset, olgoY - 5);
            ctx.lineTo(this.x - 20 + offset, olgoY + 5);
            ctx.stroke();
        }
    }

    // ================= UTILIDADES =================
    hitbox() {
        return { 
            x: this.x - this.tamanho/2, 
            y: this.y - this.tamanho, 
            w: this.tamanho, 
            h: this.tamanho + 20
        };
    }
    
    reset() {
        this.x = this.inicialX;
        this.y = CONFIG.CHAO;
        this.vy = 0;
        this.vida = 100;
        this.vivo = true;
        
        // Estados
        this.pulando = false;
        this.atacando = false;
        this.chutando = false;
        this.descendoRapido = false;
        this.transformado = false;
        
        // Temporizadores
        this.tempoAtaque = 0;
        this.tempoChute = 0;
        this.tempoTransformacao = 0;
        
        // Outros
        this.olhosAbertos = true;
        this.tempoPiscar = 0;
        this.sapatoX = 0;
        this.sapatoY = 0;
        this.cdPoder = 0;
        this.cocosAtivos = [];
        this.cargaPoder = 0;
    }
}

// ================= M√ìDULO: GAME MANAGER =================
class GameManager {
    constructor() {
        this.canvas = document.getElementById("game");
        this.ctx = this.canvas.getContext("2d");
        this.fundo = new Image();
        this.fundo.src = "imagens/fundo.png";
        
        // Estado do jogo
        this.jogoTerminou = false;
        this.meuId = null;
        this.inimigoId = null;
        
        // Jogadores
        this.p1 = null;
        this.p2 = null;
        
        // Input
        this.keys = {};
        this.setupInput();
    }
    
    setupInput() {
        addEventListener("keydown", e => this.keys[e.key] = true);
        addEventListener("keyup", e => this.keys[e.key] = false);
    }
    
    inicializar() {
        const meuPlayer = prompt("Digite 1 para Player 1 ou 2 para Player 2");
        this.meuId = meuPlayer === "1" ? "p1" : "p2";
        this.inimigoId = this.meuId === "p1" ? "p2" : "p1";
        
        // Criar jogadores
        this.p1 = new LutadorCoco(
            250, 
            "#8B7355", 
            "cyan", 
            {esq: "a", dir: "d", pulo: "w", atk: "f"}, 
            1, 
            "p1"
        );
        
        this.p2 = new LutadorCoco(
            650, 
            "#8B7355", 
            "red", 
            {esq: "ArrowLeft", dir: "ArrowRight", pulo: "ArrowUp", atk: "Enter"}, 
            -1, 
            "p2"
        );
        
        // Configurar Firebase
        this.setupFirebase();
        
        // Iniciar loop
        this.fundo.onload = () => this.loop();
    }
    
    setupFirebase() {
        // Enviar dados
        this.enviarDados = () => {
            if (this.jogoTerminou) return;
            
            const jogador = this.meuId === "p1" ? this.p1 : this.p2;
            
            db.ref("jogo/" + this.meuId).set({
                x: jogador.x,
                y: jogador.y,
                vida: jogador.vida,
                dir: jogador.dir,
                atacando: jogador.atacando,
                chutando: jogador.chutando,
                vivo: jogador.vivo,
                pulando: jogador.pulando,
                sapatoX: jogador.sapatoX,
                sapatoY: jogador.sapatoY,
                olhosAbertos: jogador.olhosAbertos,
                descendoRapido: jogador.descendoRapido,
                transformado: jogador.transformado,
                cdPoder: jogador.cdPoder,
                cargaPoder: jogador.cargaPoder
            });
        };
        
        // Receber dados do inimigo
        db.ref("jogo/" + this.inimigoId).on("value", s => {
            const dados = s.val();
            if (!dados) return;
            
            const inimigo = this.inimigoId === "p1" ? this.p1 : this.p2;
            
            // Atualizar dados b√°sicos
            Object.assign(inimigo, {
                x: dados.x,
                y: dados.y,
                dir: dados.dir,
                atacando: dados.atacando,
                chutando: dados.chutando,
                pulando: dados.pulando,
                sapatoX: dados.sapatoX,
                sapatoY: dados.sapatoY,
                olhosAbertos: dados.olhosAbertos,
                descendoRapido: dados.descendoRapido,
                transformado: dados.transformado,
                cdPoder: dados.cdPoder,
                cargaPoder: dados.cargaPoder
            });
            
            // Vida
            if (dados.vida !== undefined && dados.vida < inimigo.vida) {
                inimigo.vida = dados.vida;
            }
            
            // Estado de vida
            if (dados.vivo !== undefined) {
                inimigo.vivo = dados.vivo;
                if (!dados.vivo) inimigo.vida = 0;
            }
        });
        
        // Coc√¥s lan√ßados
        db.ref("cocoLancado").on("value", s => {
            const dados = s.val();
            if (!dados || dados.jogador === this.meuId || this.jogoTerminou) return;
            
            const jogador = dados.jogador === "p1" ? this.p1 : this.p2;
            const coco = new CocoProjetil(dados.x, dados.y, dados.direcao, jogador.cor, dados.jogador);
            jogador.cocosAtivos.push(coco);
        });
        
        // Rein√≠cio
        db.ref("reinicio").on("value", s => {
            const dados = s.val();
            if (dados) this.reiniciarJogo();
        });
    }
    
    reiniciarJogo() {
        this.p1.reset();
        this.p2.reset();
        this.jogoTerminou = false;
        
        this.enviarDados();
        
        setTimeout(() => {
            db.ref("jogo").set({
                p1: this.getDadosJogador(this.p1),
                p2: this.getDadosJogador(this.p2)
            });
            db.ref("cocoLancado").remove();
        }, 100);
    }
    
    getDadosJogador(jogador) {
        return {
            x: jogador.x,
            y: jogador.y,
            vida: jogador.vida,
            dir: jogador.dir,
            atacando: false,
            chutando: false,
            vivo: true,
            pulando: false,
            sapatoX: 0,
            sapatoY: 0,
            olhosAbertos: true,
            descendoRapido: false,
            transformado: false,
            cdPoder: 0,
            cargaPoder: 0
        };
    }
    
    // ================= UI =================
    desenharBarrasVida() {
        // P1
        Utils.desenharBarra(this.ctx, 50, 20, 200, 25, this.p1.vida, 100, "#333", "cyan");
        // P2
        Utils.desenharBarra(this.ctx, 650, 20, 200, 25, this.p2.vida, 100, "#333", "red");
        
        // Texto
        this.ctx.fillStyle = "white";
        this.ctx.font = "16px Arial";
        this.ctx.fillText(`P1: ${this.p1.vida}`, 50, 50);
        this.ctx.fillText(`P2: ${this.p2.vida}`, 650, 50);
        
        // Controles
        this.ctx.font = "14px Arial";
        this.ctx.fillText("Soco: F | Chute: C | Bomba: W+S", 50, 70);
        this.ctx.fillText("Soco: Enter | Chute: . | Bomba: ‚Üë+‚Üì", 650, 70);
        
        this.ctx.font = "12px Arial";
        this.ctx.textAlign = "center";
        this.ctx.fillText("Pular + Baixo no ar = Transforma√ß√£o + Bomba de Coc√¥!", 450, 390);
    }
    
    desenharTelaFim() {
        // Overlay
        this.ctx.fillStyle = "rgba(0, 0, 0, 0.7)";
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        
        // Texto
        this.ctx.fillStyle = "white";
        this.ctx.font = "32px Arial";
        this.ctx.textAlign = "center";
        
        const vencedor = this.p1.vivo ? "Player 1 VENCEU! üí©üëë" : "Player 2 VENCEU! üí©üëë";
        this.ctx.fillText(vencedor, this.canvas.width / 2, 150);
        
        this.ctx.font = "24px Arial";
        this.ctx.fillText("Pressione R para jogar novamente", this.canvas.width / 2, 200);
        
        this.ctx.font = "18px Arial";
        this.ctx.fillText("Ambos os jogadores precisam pressionar R", this.canvas.width / 2, 240);
    }
    
    // ================= LOOP PRINCIPAL =================
    loop() {
        // Limpar
        this.ctx.clearRect(0, 0, 900, 400);
        this.ctx.drawImage(this.fundo, 0, CONFIG.CHAO - 40, 900, 180);
        
        // Desenhar UI
        this.desenharBarrasVida();
        
        // Verificar fim do jogo
        if (!this.p1.vivo || !this.p2.vivo) {
            this.jogoTerminou = true;
        }
        
        // L√≥gica do jogo
        if (!this.jogoTerminou) {
            this.atualizarJogo();
        }
        
        // Desenhar personagens
        this.p1.desenhar(this.ctx);
        this.p2.desenhar(this.ctx);
        
        // Tela de fim
        if (this.jogoTerminou) {
            this.desenharTelaFim();
            this.verificarReinicio();
        }
        
        requestAnimationFrame(() => this.loop());
    }
    
    atualizarJogo() {
        const jogador = this.meuId === "p1" ? this.p1 : this.p2;
        const inimigo = this.meuId === "p1" ? this.p2 : this.p1;
        
        // Controles do jogador local
        if (jogador.vivo) {
            jogador.mover(this.keys, this.jogoTerminou);
            jogador.pular(this.keys, this.jogoTerminou);
            jogador.atacar(this.keys, inimigo, this.jogoTerminou);
            
            // F√≠sica e verificar lan√ßamento de coc√¥
            const cocoLancado = jogador.fisica();
            if (cocoLancado) {
                db.ref("cocoLancado").set({
                    jogador: jogador.id,
                    x: cocoLancado.x,
                    y: cocoLancado.y,
                    direcao: cocoLancado.direcao,
                    tempo: Date.now()
                });
            }
        }
        
        // Atualizar coc√¥s
        jogador.atualizarCocos(inimigo);
        inimigo.atualizarCocos(jogador);
        
        // F√≠sica do inimigo
        inimigo.fisica();
        
        // Enviar dados
        this.enviarDados();
    }
    
    verificarReinicio() {
        if (this.keys["r"] || this.keys["R"]) {
            db.ref("reinicio").set({
                tempo: Date.now(),
                jogador: this.meuId
            });
            
            this.reiniciarJogo();
            
            setTimeout(() => {
                db.ref("reinicio").remove();
            }, 1000);
        }
    }
}

// ================= INICIALIZAR JOGO =================
const game = new GameManager();
game.inicializar();
</script>
</body>
</html>
