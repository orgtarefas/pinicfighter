<script>
// ================= FIREBASE CONFIG =================
const FIREBASE_CONFIG = {
    apiKey: "AIzaSyDy_gqNrFR7KmMonXp7KfgRc15UVj0g3Nw",
    authDomain: "pinico-fighter.firebaseapp.com",
    databaseURL: "https://pinico-fighter-default-rtdb.firebaseio.com",
    projectId: "pinico-fighter",
    storageBucket: "pinico-fighter.firebasestorage.app",
    messagingSenderId: "152199667347",
    appId: "1:152199667347:web:9c74188c88bdee8633f766"
};

// ================= M√ìDULO: GAME MANAGER =================
class GameManager {
    constructor() {
        this.canvas = document.getElementById("game");
        this.ctx = this.canvas.getContext("2d");
        this.fundo = new Image();
        this.fundo.src = "imagens/fundo.png";
        
        // Estado do jogo
        this.jogoTerminou = false;
        this.meuId = null;
        this.inimigoId = null;
        
        // Jogadores
        this.p1 = null;
        this.p2 = null;
        
        // Input
        this.keys = {};
        this.setupInput();
        
        // Firebase
        this.db = null;
        this.setupFirebase();
    }
    
    setupInput() {
        addEventListener("keydown", e => this.keys[e.key] = true);
        addEventListener("keyup", e => this.keys[e.key] = false);
    }
    
    setupFirebase() {
        firebase.initializeApp(FIREBASE_CONFIG);
        this.db = firebase.database();
    }
    
    inicializar() {
        // Perguntar qual player
        const meuPlayer = prompt("Digite 1 para Player 1 ou 2 para Player 2");
        this.meuId = meuPlayer === "1" ? "p1" : "p2";
        this.inimigoId = this.meuId === "p1" ? "p2" : "p1";
        
        // Criar jogadores
        this.p1 = new LutadorCoco(
            250, 
            "#8B7355", 
            "cyan", 
            {esq: "a", dir: "d", pulo: "w", atk: "f"}, 
            1, 
            "p1"
        );
        
        this.p2 = new LutadorCoco(
            650, 
            "#8B7355", 
            "red", 
            {esq: "ArrowLeft", dir: "ArrowRight", pulo: "ArrowUp", atk: "Enter"}, 
            -1, 
            "p2"
        );
        
        // Configurar listeners do Firebase
        this.setupFirebaseListeners();
        
        // Iniciar loop do jogo
        this.fundo.onload = () => this.loop();
    }
    
    setupFirebaseListeners() {
        // Receber dados do inimigo
        this.db.ref("jogo/" + this.inimigoId).on("value", s => {
            const dados = s.val();
            if (!dados) return;
            
            const inimigo = this.inimigoId === "p1" ? this.p1 : this.p2;
            this.atualizarDadosInimigo(inimigo, dados);
        });
        
        // Coc√¥s lan√ßados
        this.db.ref("cocoLancado").on("value", s => {
            const dados = s.val();
            if (!dados || dados.jogador === this.meuId || this.jogoTerminou) return;
            
            const jogador = dados.jogador === "p1" ? this.p1 : this.p2;
            const coco = new CocoProjetil(dados.x, dados.y, dados.direcao, jogador.cor, dados.jogador);
            jogador.cocosAtivos.push(coco);
        });
        
        // Rein√≠cio
        this.db.ref("reinicio").on("value", s => {
            const dados = s.val();
            if (dados) this.reiniciarJogo();
        });
    }
    
    atualizarDadosInimigo(inimigo, dados) {
        // Atualizar dados b√°sicos
        Object.assign(inimigo, {
            x: dados.x,
            y: dados.y,
            dir: dados.dir,
            atacando: dados.atacando,
            chutando: dados.chutando,
            pulando: dados.pulando,
            sapatoX: dados.sapatoX,
            sapatoY: dados.sapatoY,
            olhosAbertos: dados.olhosAbertos,
            descendoRapido: dados.descendoRapido,
            transformado: dados.transformado,
            cdPoder: dados.cdPoder,
            cargaPoder: dados.cargaPoder
        });
        
        // Vida
        if (dados.vida !== undefined && dados.vida < inimigo.vida) {
            inimigo.vida = dados.vida;
        }
        
        // Estado de vida
        if (dados.vivo !== undefined) {
            inimigo.vivo = dados.vivo;
            if (!dados.vivo) inimigo.vida = 0;
        }
    }
    
    enviarDados() {
        if (this.jogoTerminou) return;
        
        const jogador = this.meuId === "p1" ? this.p1 : this.p2;
        
        this.db.ref("jogo/" + this.meuId).set({
            x: jogador.x,
            y: jogador.y,
            vida: jogador.vida,
            dir: jogador.dir,
            atacando: jogador.atacando,
            chutando: jogador.chutando,
            vivo: jogador.vivo,
            pulando: jogador.pulando,
            sapatoX: jogador.sapatoX,
            sapatoY: jogador.sapatoY,
            olhosAbertos: jogador.olhosAbertos,
            descendoRapido: jogador.descendoRapido,
            transformado: jogador.transformado,
            cdPoder: jogador.cdPoder,
            cargaPoder: jogador.cargaPoder
        });
    }
    
    enviarCocoLancado(coco) {
        if (this.jogoTerminou) return;
        
        this.db.ref("cocoLancado").set({
            jogador: this.meuId,
            x: coco.x,
            y: coco.y,
            direcao: coco.direcao,
            tempo: Date.now()
        });
    }
    
    reiniciarJogo() {
        this.p1.reset();
        this.p2.reset();
        this.jogoTerminou = false;
        
        // Enviar dados atualizados
        this.enviarDados();
        
        // Sincronizar estado inicial
        setTimeout(() => {
            this.db.ref("jogo").set({
                p1: this.getDadosJogador(this.p1),
                p2: this.getDadosJogador(this.p2)
            });
            this.db.ref("cocoLancado").remove();
        }, 100);
    }
    
    getDadosJogador(jogador) {
        return {
            x: jogador.x,
            y: jogador.y,
            vida: jogador.vida,
            dir: jogador.dir,
            atacando: false,
            chutando: false,
            vivo: true,
            pulando: false,
            sapatoX: 0,
            sapatoY: 0,
            olhosAbertos: true,
            descendoRapido: false,
            transformado: false,
            cdPoder: 0,
            cargaPoder: 0
        };
    }
    
    // ================= UI =================
    desenharBarrasVida() {
        // Barra P1
        Utils.desenharBarra(this.ctx, 50, 20, 200, 25, this.p1.vida, 100, "#333", "cyan");
        Utils.desenharTexto(this.ctx, `P1: ${this.p1.vida}`, 50, 50, 16, "white");
        
        // Barra P2
        Utils.desenharBarra(this.ctx, 650, 20, 200, 25, this.p2.vida, 100, "#333", "red");
        Utils.desenharTexto(this.ctx, `P2: ${this.p2.vida}`, 650, 50, 16, "white");
        
        // Controles
        Utils.desenharTexto(this.ctx, "Soco: F | Chute: C | Bomba: W+S", 50, 70, 14, "white");
        Utils.desenharTexto(this.ctx, "Soco: Enter | Chute: . | Bomba: ‚Üë+‚Üì", 650, 70, 14, "white");
        
        // Instru√ß√£o
        Utils.desenharTexto(this.ctx, "Pular + Baixo no ar = Transforma√ß√£o + Bomba de Coc√¥!", 
            450, 390, 12, "white", "center");
    }
    
    desenharTelaFim() {
        // Overlay
        this.ctx.fillStyle = "rgba(0, 0, 0, 0.7)";
        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
        
        // Texto do vencedor
        const vencedor = this.p1.vivo ? "Player 1 VENCEU! üí©üëë" : "Player 2 VENCEU! üí©üëë";
        Utils.desenharTexto(this.ctx, vencedor, this.canvas.width / 2, 150, 32, "white", "center");
        
        // Instru√ß√µes
        Utils.desenharTexto(this.ctx, "Pressione R para jogar novamente", 
            this.canvas.width / 2, 200, 24, "white", "center");
        
        Utils.desenharTexto(this.ctx, "Ambos os jogadores precisam pressionar R", 
            this.canvas.width / 2, 240, 18, "white", "center");
    }
    
    // ================= LOOP PRINCIPAL =================
    loop() {
        // Limpar tela
        this.ctx.clearRect(0, 0, 900, 400);
        
        // Desenhar fundo
        if (this.fundo.complete) {
            this.ctx.drawImage(this.fundo, 0, CONFIG.CHAO - 40, 900, 180);
        }
        
        // Desenhar UI
        this.desenharBarrasVida();
        
        // Verificar fim do jogo
        if (!this.p1.vivo || !this.p2.vivo) {
            this.jogoTerminou = true;
        }
        
        // L√≥gica do jogo
        if (!this.jogoTerminou) {
            this.atualizarJogo();
        }
        
        // Desenhar personagens
        this.p1.desenhar(this.ctx);
        this.p2.desenhar(this.ctx);
        
        // Tela de fim
        if (this.jogoTerminou) {
            this.desenharTelaFim();
            this.verificarReinicio();
        }
        
        // Continuar loop
        requestAnimationFrame(() => this.loop());
    }
    
    atualizarJogo() {
        const jogador = this.meuId === "p1" ? this.p1 : this.p2;
        const inimigo = this.meuId === "p1" ? this.p2 : this.p1;
        
        // Controles do jogador local
        if (jogador.vivo) {
            jogador.mover(this.keys, this.jogoTerminou);
            jogador.pular(this.keys, this.jogoTerminou);
            jogador.atacar(this.keys, inimigo, this.jogoTerminou);
            
            // F√≠sica e verificar lan√ßamento de coc√¥
            const cocoLancado = jogador.fisica();
            if (cocoLancado) {
                this.enviarCocoLancado(cocoLancado);
            }
        }
        
        // Atualizar coc√¥s
        jogador.atualizarCocos(inimigo);
        inimigo.atualizarCocos(jogador);
        
        // F√≠sica do inimigo
        inimigo.fisica();
        
        // Enviar dados para Firebase
        this.enviarDados();
    }
    
    verificarReinicio() {
        if (this.keys["r"] || this.keys["R"]) {
            this.db.ref("reinicio").set({
                tempo: Date.now(),
                jogador: this.meuId
            });
            
            this.reiniciarJogo();
            
            // Limpar sinal de rein√≠cio
            setTimeout(() => {
                this.db.ref("reinicio").remove();
            }, 1000);
        }
    }
}
</script>